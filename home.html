<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Afnan AI - White Edition</title>
    
    <!-- Fonts: Noto Sans Arabic -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@300;400;600;800&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- SVGA Library -->
    <script src="https://cdn.jsdelivr.net/npm/svgaplayerweb@2.3.1/build/svga.min.js"></script>

    <style>
        /* --- Base Settings --- */
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            font-family: 'Noto Sans Arabic', sans-serif;
            touch-action: manipulation;
        }

        body {
            background: radial-gradient(circle at 0% 0%, #eef2ff 0%, #fdf2f8 50%, #f0f9ff 100%);
            color: #1f2937;
            overflow-x: hidden;
            min-height: 100vh;
        }

        /* --- iOS Glassmorphism --- */
        .glass {
            background: rgba(255, 255, 255, 0.75);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 
                0 4px 6px -1px rgba(0, 0, 0, 0.04),
                0 2px 4px -1px rgba(0, 0, 0, 0.02),
                inset 0 1px 0 0 rgba(255, 255, 255, 0.4);
        }

        .glass-deep {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(25px) saturate(200%);
            -webkit-backdrop-filter: blur(25px) saturate(200%);
            border-right: 1px solid rgba(255, 255, 255, 0.8);
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(12px) saturate(180%);
            -webkit-backdrop-filter: blur(12px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.4);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 
                0 2px 8px -2px rgba(0, 0, 0, 0.03),
                inset 0 1px 0 0 rgba(255, 255, 255, 0.5);
        }

        .glass-card:active {
            transform: scale(0.97);
            box-shadow: 
                0 1px 3px -1px rgba(0, 0, 0, 0.02),
                inset 0 2px 0 0 rgba(255, 255, 255, 0.3);
        }

        /* --- Sidebar Animation --- */
        .sidebar-container {
            position: fixed;
            top: 0;
            right: 0;
            width: 85%;
            max-width: 320px;
            height: 100%;
            z-index: 50;
            transform: translateX(110%);
            transition: transform 0.4s cubic-bezier(0.33, 1, 0.68, 1);
        }

        .sidebar-container.open {
            transform: translateX(0);
        }

        .sidebar-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.15);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            z-index: 40;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .sidebar-overlay.visible {
            opacity: 1;
            pointer-events: auto;
        }

        /* --- Avatar & Frame Logic --- */
        .avatar-wrapper {
            position: relative;
            width: 100px;
            height: 100px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .avatar-img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }

        .user-frame {
            position: absolute;
            width: 165%;
            height: 165%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
            z-index: 10;
            object-fit: contain;
        }

        /* --- SVGA Containers --- */
        .svga-container {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
        }

        .svga-avatar-frame {
            width: 165%;
            height: 165%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        /* --- Level Indicators --- */
        .level-badge {
            background: linear-gradient(135deg, rgba(255,255,255,0.9) 0%, rgba(255,255,255,0.7) 100%);
            border: 1px solid rgba(255,255,255,0.8);
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        /* --- Badges Grid --- */
        .badges-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 0.5rem;
        }

        /* --- General Animations --- */
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .loader {
            border: 3px solid rgba(0,0,0,0.1);
            border-left-color: #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* --- Gift Animation --- */
        @keyframes giftFly {
            0% { transform: translate(-50%, 100%) scale(0.5); opacity: 0; }
            20% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
            80% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
            100% { transform: translate(150%, -150%) scale(0.5); opacity: 0; }
        }
        
        @keyframes giftSend {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            50% { transform: translateY(-20px) scale(1.1); opacity: 0.8; }
            100% { transform: translateY(-100px) scale(0.5); opacity: 0; }
        }
        
        .gift-animation {
            position: fixed;
            left: 50%;
            top: 50%;
            z-index: 100;
            pointer-events: none;
            animation: giftFly 3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }
        
        .gift-send-animation {
            animation: giftSend 1s ease-in-out forwards;
        }

        /* --- Hide Scrollbar --- */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* --- Chat Styles --- */
        .chat-bubble-me {
            background: #1f2937;
            color: white;
            border-radius: 20px 20px 4px 20px;
        }
        .chat-bubble-them {
            background: white;
            color: #1f2937;
            border-radius: 20px 20px 20px 4px;
            border: 1px solid rgba(0,0,0,0.05);
        }

        .gift-message {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 2px solid #fbbf24;
            border-radius: 20px;
            padding: 12px;
            text-align: center;
            margin: 8px 0;
        }

        .gift-message-icon {
            width: 48px;
            height: 48px;
            margin: 0 auto 8px;
        }

        /* --- SVGA Preview in Store --- */
        .svga-preview {
            width: 100%;
            height: 80px;
            background: rgba(0,0,0,0.05);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .svga-icon {
            font-size: 10px;
            background: #3b82f6;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            margin-top: 4px;
        }
        
        /* --- Bubble Message Styles --- */
        .bubble-preview {
            width: 100%;
            height: 80px;
            background: rgba(0,0,0,0.05);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
        }
        
        .bubble-text {
            font-size: 14px;
            font-weight: bold;
            color: #1f2937;
            padding: 8px 16px;
            border-radius: 20px;
            max-width: 80%;
            text-align: center;
        }
        
        /* --- Level Requirements from Firestore --- */
        .level-requirement {
            font-size: 10px;
            color: #6b7280;
            margin-top: 4px;
        }
    </style>
</head>
<body class="antialiased selection:bg-blue-100 selection:text-blue-900">

    <!-- ================= MAIN APP ================= -->
    <div id="main-app" class="min-h-screen pb-24">
        
        <!-- HEADER -->
        <header class="fixed top-0 left-0 right-0 h-20 z-30 px-6 flex items-center justify-between glass">
            <h2 id="pageTitle" class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-gray-900 to-gray-600">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</h2>
            <button onclick="toggleSidebar(true)" class="w-10 h-10 rounded-full flex items-center justify-center active:scale-90 transition">
                <i data-lucide="menu" class="text-black w-6 h-6"></i>
            </button>
        </header>

        <!-- VIEW CONTAINER -->
        <main class="pt-24 px-5">

            <!-- VIEW: HOME -->
            <div id="view-home" class="view-section fade-in">
                <div id="homeBanner" class="w-full h-48 rounded-[32px] glass-card mb-6 relative overflow-hidden flex items-center justify-center shadow-sm group"></div>
                <div class="flex p-1 bg-white/60 backdrop-blur-md rounded-2xl mb-6 shadow-sm border border-white/40">
                    <button id="btn-public" onclick="filterRooms('public')" class="flex-1 py-3 rounded-xl bg-white text-black font-bold shadow-sm text-sm transition-all">Ø¹Ø§Ù…Ø©</button>
                    <button id="btn-private" onclick="filterRooms('private')" class="flex-1 py-3 rounded-xl text-gray-500 font-bold text-sm hover:text-black transition-all">Ø®Ø§ØµØ©</button>
                </div>
                <div id="roomsGrid" class="space-y-3"></div>
            </div>

            <!-- VIEW: WALLET -->
            <div id="view-wallet" class="view-section hidden fade-in">
                <div class="glass-card rounded-[40px] p-8 text-center mb-8 relative overflow-hidden">
                    <div class="absolute -top-20 -left-20 w-48 h-48 bg-yellow-200/30 rounded-full blur-3xl"></div>
                    <div class="relative z-10">
                        <p class="text-gray-500 text-sm font-semibold mb-2">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„ÙƒÙ„ÙŠ</p>
                        <h2 class="text-6xl font-black text-gray-900 tracking-tight mb-2" id="walletAmount">0</h2>
                        <span class="inline-flex items-center gap-1 bg-yellow-100 text-yellow-700 px-3 py-1 rounded-full text-xs font-bold">
                            <i data-lucide="coins" class="w-3 h-3"></i> Ø¹Ù…Ù„Ø© Ø°Ù‡Ø¨ÙŠØ©
                        </span>
                    </div>
                </div>
                <h3 class="font-bold text-xl mb-4 mr-2">Ø´Ø­Ù† Ø§Ù„Ø±ØµÙŠØ¯</h3>
                <div class="grid grid-cols-2 gap-4">
                    <div onclick="recharge(85000)" class="glass-card p-6 rounded-3xl flex flex-col items-center justify-center gap-2 cursor-pointer hover:bg-white transition">
                        <span class="text-2xl font-black text-gray-900">85,000</span>
                        <span class="text-gray-400 text-xs">$1</span>
                    </div>
                </div>
            </div>

            <!-- VIEW: STORE -->
            <div id="view-store" class="view-section hidden fade-in">
                <div class="flex gap-3 mb-6 overflow-x-auto no-scrollbar pb-2">
                    <button onclick="loadStoreItems('frames')" id="store-tab-frames" class="flex-none px-6 py-2.5 bg-gray-900 text-white rounded-full font-bold text-sm shadow-lg hover:bg-gray-800 transition">Ø¥Ø·Ø§Ø±Ø§Øª</button>
                    <button onclick="loadStoreItems('badges')" id="store-tab-badges" class="flex-none px-6 py-2.5 glass-card text-gray-600 rounded-full font-bold text-sm hover:bg-white transition">Ø´Ø§Ø±Ø§Øª</button>
                    <button onclick="loadStoreItems('svga')" id="store-tab-svga" class="flex-none px-6 py-2.5 glass-card text-gray-600 rounded-full font-bold text-sm hover:bg-white transition">Ø±Ø³ÙˆÙ… Ù…ØªØ­Ø±ÙƒØ©</button>
                    <button onclick="loadStoreItems('bubbles')" id="store-tab-bubbles" class="flex-none px-6 py-2.5 glass-card text-gray-600 rounded-full font-bold text-sm hover:bg-white transition">ÙÙ‚Ø§Ø¹Ø§Øª Ø§Ù„ÙƒØªØ§Ø¨Ø©</button>
                </div>
                <div id="storeGrid" class="grid grid-cols-2 gap-4 pb-20"></div>
            </div>

            <!-- VIEW: BAG -->
            <div id="view-bag" class="view-section hidden fade-in">
                <h3 class="font-bold text-lg mb-4 text-gray-800">Ø¥Ø·Ø§Ø±Ø§ØªÙŠ</h3>
                <div id="bagGrid" class="grid grid-cols-3 gap-3 mb-8"></div>
                <h3 class="font-bold text-lg mb-4 text-gray-800">Ø´Ø§Ø±Ø§ØªÙŠ</h3>
                <div id="badgesBagGrid" class="badges-grid mb-8"></div>
                <h3 class="font-bold text-lg mb-4 text-gray-800">Ø±Ø³ÙˆÙ… Ù…ØªØ­Ø±ÙƒØ©</h3>
                <div id="svgaBagGrid" class="grid grid-cols-3 gap-3 mb-8"></div>
                <h3 class="font-bold text-lg mb-4 text-gray-800">Ø´Ø§Ø±Ø§ØªÙŠ Ø§Ù„Ù†Ø´Ø·Ø©</h3>
                <div id="activeBadgesGrid" class="badges-grid mb-8"></div>
                <h3 class="font-bold text-lg mb-4 text-gray-800">ÙÙ‚Ø§Ø¹Ø§Øª Ø§Ù„ÙƒØªØ§Ø¨Ø©</h3>
                <div id="bubblesBagGrid" class="grid grid-cols-3 gap-3 mb-8"></div>
            </div>

            <!-- VIEW: FRIENDS -->
            <div id="view-friends" class="view-section hidden fade-in">
                <div class="relative mb-6">
                    <input type="text" id="searchUserInput" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ø³ØªØ®Ø¯Ù… Ø¨ÙˆØ§Ø³Ø·Ø© Ø§Ù„Ù€ ID..." 
                           class="w-full p-4 pr-12 rounded-2xl glass-card border-0 focus:ring-0 focus:outline-none text-sm">
                    <button onclick="searchUser()" class="absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600">
                        <i data-lucide="search" class="w-5 h-5"></i>
                    </button>
                </div>
                <div id="searchResults" class="space-y-3 mb-8 hidden">
                    <h3 class="font-bold text-lg text-gray-800">Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«</h3>
                    <div id="userResult" class="glass-card p-4 rounded-3xl"></div>
                </div>
                <h3 class="font-bold text-lg mb-4 text-gray-800">Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©</h3>
                <div id="friendRequestsList" class="space-y-3 mb-6"></div>
                <h3 class="font-bold text-lg mb-4 text-gray-800">Ø£ØµØ¯Ù‚Ø§Ø¦ÙŠ</h3>
                <div id="friendsList" class="space-y-3"></div>
            </div>
        </main>
    </div>

    <!-- ================= SIDEBAR ================= -->
    <div id="sidebarOverlay" class="sidebar-overlay" onclick="toggleSidebar(false)"></div>
    <aside id="sidebar" class="sidebar-container glass-deep flex flex-col overflow-hidden">
        <div class="pt-12 px-6 flex justify-between items-start">
             <button onclick="toggleSidebar(false)" class="p-2 rounded-full bg-gray-100/50 hover:bg-gray-200/50 transition">
                <i data-lucide="x" class="w-5 h-5 text-gray-500"></i>
            </button>
            <button onclick="openEditProfile()" class="p-3 rounded-full glass hover:bg-white transition shadow-sm group">
                <i data-lucide="edit-3" class="w-5 h-5 text-gray-600 group-hover:text-black"></i>
            </button>
        </div>
        <div class="flex-1 overflow-y-auto no-scrollbar px-6 pt-2 pb-10">
            <div class="mb-6 mt-4">
                <div class="avatar-wrapper">
                    <img id="sideAvatar" src="https://via.placeholder.com/150" class="avatar-img">
                    <div id="sideSvgaFrame" class="svga-container svga-avatar-frame"></div>
                    <img id="sideFrame" src="" class="user-frame hidden">
                </div>
            </div>
            <div class="text-center mb-6">
                <h3 id="sideName" class="text-2xl font-black text-gray-900 mb-1">...</h3>
                <div class="inline-flex items-center gap-2 bg-gray-100/50 px-3 py-1 rounded-lg border border-gray-200/50">
                    <span class="text-xs font-bold text-gray-400">ID:</span>
                    <span id="sideID" class="text-sm font-mono font-medium text-gray-600">...</span>
                    <button onclick="copyID()" class="text-gray-400 hover:text-black"><i data-lucide="copy" class="w-3 h-3"></i></button>
                </div>
            </div>
            <div class="flex gap-3 mb-8">
                <div class="flex-1 glass-card p-3 rounded-2xl flex flex-col items-center justify-center gap-1">
                    <div class="w-16 h-16 flex items-center justify-center overflow-hidden">
                        <img id="magicLevelImg" src="" class="w-full h-full object-contain">
                    </div>
                    <span class="text-[10px] text-gray-400 font-bold uppercase mt-2">Ø§Ù„Ø³Ø­Ø±</span>
                    <div class="level-requirement" id="magicLevelReq"></div>
                </div>
                <div class="flex-1 glass-card p-3 rounded-2xl flex flex-col items-center justify-center gap-1">
                    <div class="w-16 h-16 flex items-center justify-center overflow-hidden">
                        <img id="wealthLevelImg" src="" class="w-full h-full object-contain">
                    </div>
                    <span class="text-[10px] text-gray-400 font-bold uppercase mt-2">Ø§Ù„Ø«Ø±ÙˆØ©</span>
                    <div class="level-requirement" id="wealthLevelReq"></div>
                </div>
            </div>
            <div class="mb-6">
                <div id="sidebarActiveBadges" class="badges-grid"></div>
            </div>
            <nav class="space-y-3">
                <button onclick="switchView('home')" class="w-full flex items-center gap-4 p-4 rounded-3xl glass-card hover:bg-white hover:scale-[1.02] transition-all text-gray-700 font-bold">
                    <div class="w-10 h-10 rounded-2xl bg-gray-50 flex items-center justify-center"><i data-lucide="home" class="w-5 h-5 text-gray-500"></i></div>
                    Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
                </button>
                <button onclick="switchView('wallet')" class="w-full flex items-center gap-4 p-4 rounded-3xl glass-card hover:bg-white hover:scale-[1.02] transition-all text-gray-700 font-bold">
                    <div class="w-10 h-10 rounded-2xl bg-gray-50 flex items-center justify-center"><i data-lucide="wallet" class="w-5 h-5 text-gray-500"></i></div>
                    Ø§Ù„Ù…Ø­ÙØ¸Ø©
                </button>
                <button onclick="switchView('store')" class="w-full flex items-center gap-4 p-4 rounded-3xl glass-card hover:bg-white hover:scale-[1.02] transition-all text-gray-700 font-bold">
                    <div class="w-10 h-10 rounded-2xl bg-gray-50 flex items-center justify-center"><i data-lucide="shopping-bag" class="w-5 h-5 text-gray-500"></i></div>
                    Ø§Ù„Ù…ØªØ¬Ø±
                </button>
                <button onclick="switchView('bag')" class="w-full flex items-center gap-4 p-4 rounded-3xl glass-card hover:bg-white hover:scale-[1.02] transition-all text-gray-700 font-bold">
                    <div class="w-10 h-10 rounded-2xl bg-gray-50 flex items-center justify-center"><i data-lucide="backpack" class="w-5 h-5 text-gray-500"></i></div>
                    Ø­Ù‚ÙŠØ¨ØªÙŠ
                </button>
                <button onclick="switchView('friends')" class="w-full flex items-center gap-4 p-4 rounded-3xl glass-card hover:bg-white hover:scale-[1.02] transition-all text-gray-700 font-bold">
                    <div class="w-10 h-10 rounded-2xl bg-gray-50 flex items-center justify-center"><i data-lucide="users" class="w-5 h-5 text-gray-500"></i></div>
                    Ø£ØµØ¯Ù‚Ø§Ø¦ÙŠ
                </button>
            </nav>
            <div class="mt-8">
                <button onclick="confirmLogout()" class="w-full p-4 rounded-3xl bg-red-50/50 text-red-500 font-bold hover:bg-red-100 transition flex items-center justify-center gap-2">
                    <i data-lucide="log-out" class="w-5 h-5"></i>
                    ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬
                </button>
            </div>
        </div>
    </aside>

    <!-- ================= CHAT MODAL ================= -->
    <div id="chatModal" class="fixed inset-0 z-[60] hidden flex flex-col bg-gray-50">
        <header class="h-20 glass flex items-center px-6 justify-between">
            <div class="flex items-center gap-3">
                <button onclick="closeChat()" class="p-2 rounded-full hover:bg-gray-100"><i data-lucide="chevron-right" class="w-6 h-6"></i></button>
                <div class="flex items-center gap-2">
                    <img id="chatUserAvatar" src="" class="w-10 h-10 rounded-full object-cover">
                    <div>
                        <h4 id="chatUserName" class="font-bold text-sm">...</h4>
                        <p class="text-[10px] text-green-500 font-bold">Ù…ØªØµÙ„ Ø§Ù„Ø¢Ù†</p>
                    </div>
                </div>
            </div>
            <button onclick="toggleGiftBox()" class="w-10 h-10 rounded-full bg-yellow-100 flex items-center justify-center text-yellow-600"><i data-lucide="gift" class="w-5 h-5"></i></button>
        </header>
        <div id="chatMessages" class="flex-1 overflow-y-auto p-6 space-y-4 no-scrollbar"></div>
        <div class="p-4 glass flex gap-2 items-center">
            <input type="text" id="chatInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§..." class="flex-1 p-4 rounded-2xl bg-white border-0 focus:ring-0 text-sm">
            <button onclick="sendMessage()" class="w-12 h-12 rounded-2xl bg-black text-white flex items-center justify-center shadow-lg"><i data-lucide="send" class="w-5 h-5"></i></button>
        </div>
    </div>

    <!-- ================= GIFT BOX ================= -->
    <div id="giftBox" class="fixed inset-0 z-[70] hidden">
        <div class="absolute inset-0 bg-black/20 backdrop-blur-sm" onclick="toggleGiftBox()"></div>
        <div class="absolute bottom-0 left-0 right-0 bg-white rounded-t-[40px] h-[45vh] flex flex-col overflow-hidden shadow-2xl">
            <div class="p-6 flex justify-between items-center border-b border-gray-100">
                <div class="flex gap-4">
                    <button onclick="switchGiftTab('fixed')" id="tab-fixed" class="font-bold text-black border-b-2 border-black pb-1">Ù‡Ø¯Ø§ÙŠØ§ Ø«Ø§Ø¨ØªØ©</button>
                    <button onclick="switchGiftTab('luck')" id="tab-luck" class="font-bold text-gray-400 pb-1">Ù‡Ø¯Ø§ÙŠØ§ Ø§Ù„Ø­Ø¸</button>
                </div>
                <div class="flex items-center gap-1 bg-yellow-50 px-3 py-1 rounded-full">
                    <i data-lucide="coins" class="w-3 h-3 text-yellow-600"></i>
                    <span id="giftWalletBalance" class="text-xs font-bold text-yellow-700">0</span>
                </div>
            </div>
            <div id="giftGrid" class="flex-1 overflow-y-auto p-6 grid grid-cols-4 gap-4 no-scrollbar"></div>
            <div class="p-4 border-t border-gray-100">
                <button onclick="sendSelectedGift()" id="sendGiftBtn" class="w-full py-3 bg-black text-white rounded-2xl font-bold flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                    <i data-lucide="send" class="w-4 h-4"></i>
                    Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù‡Ø¯ÙŠØ©
                </button>
            </div>
        </div>
    </div>

    <!-- ================= EDIT MODAL ================= -->
    <div id="editModal" class="fixed inset-0 z-[60] hidden flex items-center justify-center px-4">
        <div class="absolute inset-0 bg-black/20 backdrop-blur-sm" onclick="closeEditModal()"></div>
        <div class="relative w-full max-w-sm glass-deep rounded-[40px] p-6 shadow-2xl fade-in">
            <h3 class="text-center font-bold text-xl mb-6">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù„Ù</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-400 mb-2 mr-2">Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¸Ø§Ù‡Ø±</label>
                    <input id="editNameInp" type="text" class="w-full p-4 rounded-2xl bg-gray-50/50 border border-gray-100 focus:bg-white focus:outline-none transition font-bold text-center">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-400 mb-2 mr-2">Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø©</label>
                    <input id="editPhotoInp" type="text" class="w-full p-4 rounded-2xl bg-gray-50/50 border border-gray-100 focus:bg-white focus:outline-none transition text-xs text-center text-gray-500">
                </div>
            </div>
            <div class="flex gap-3 mt-8">
                <button onclick="closeEditModal()" class="flex-1 py-3 rounded-2xl bg-gray-100 text-gray-500 font-bold hover:bg-gray-200">Ø¥Ù„ØºØ§Ø¡</button>
                <button onclick="saveProfileChanges()" class="flex-1 py-3 rounded-2xl bg-black text-white font-bold hover:shadow-lg hover:-translate-y-1 transition">Ø­ÙØ¸</button>
            </div>
        </div>
    </div>

// ================= Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ù…Ø­Ø³Ù† Ù…Ù† Ø§Ù„Ù€ script =================

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { 
        getAuth, 
        TwitterAuthProvider, 
        GoogleAuthProvider, 
        signInWithPopup, 
        signOut, 
        onAuthStateChanged 
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { 
        getFirestore, 
        doc, 
        getDoc, 
        setDoc, 
        updateDoc, 
        onSnapshot, 
        collection, 
        getDocs, 
        increment, 
        query, 
        where, 
        arrayUnion, 
        arrayRemove,
        writeBatch
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { 
        getDatabase, 
        ref, 
        push, 
        onValue, 
        set 
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBnmqWRY6lV54meFvO89QeXwtd28w81FcY",
        authDomain: "rtx3090-28439.firebaseapp.com",
        projectId: "rtx3090-28439",
        storageBucket: "rtx3090-28439.firebasestorage.app",
        messagingSenderId: "178612030690",
        appId: "1:178612030690:web:883189ced2ed3a78e3e2bb",
        databaseURL: "https://rtx3090-28439-default-rtdb.firebaseio.com/"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const rtdb = getDatabase(app);

    let userData = {};
    let storeData = { 
        frames: [], badges: [], svga: [], gifts: [], luckGifts: [], 
        magicLevels: {}, wealthLevels: {}, bubbles: [], levelRequirements: {} 
    };
    let currentChatFriend = null;
    let chatUnsubscribe = null;
    let activeSvgaPlayers = {};
    let selectedGift = null;
    
    // ================= Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ø°ÙƒÙŠ =================
    
    // 1. ØªØªØ¨Ø¹ Ø­Ø§Ù„Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    const USER_CREATION_FLAG = 'afnan_ai_user_created';
    
    // 2. ØªÙˆÙ‚ÙŠØ¹ ÙØ±ÙŠØ¯ Ù„ÙƒÙ„ Ø¬Ù‡Ø§Ø²
    const getDeviceSignature = () => {
        const keys = [
            'userAgent',
            'language',
            'platform',
            'hardwareConcurrency',
            'deviceMemory'
        ];
        
        let signature = '';
        keys.forEach(key => {
            if (navigator[key]) {
                signature += navigator[key].toString().substring(0, 3);
            }
        });
        
        return btoa(signature).substring(0, 10);
    };
    
    // 3. Ø¹Ù„Ø§Ù…Ø© Ù…Ø§Ø¦ÙŠØ© Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    const createDataWatermark = (uid) => {
        return {
            _protected: true,
            _uid: uid,
            _created: new Date().toISOString(),
            _device: getDeviceSignature(),
            _version: '2.0'
        };
    };
    
    // 4. ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø¹Ù„Ø§Ù…Ø© Ù…Ø§Ø¦ÙŠØ©
    const validateDataWatermark = (data, uid) => {
        if (!data || typeof data !== 'object') return false;
        if (!data._protected) return false;
        if (data._uid !== uid) return false;
        return true;
    };
    
    // 5. ØªØ­Ù‚Ù‚ Ø´Ø§Ù…Ù„ Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    const validateUserDocument = async (user) => {
        const userDocRef = doc(db, "users", user.uid);
        
        try {
            const docSnap = await getDoc(userDocRef);
            
            if (docSnap.exists()) {
                const data = docSnap.data();
                
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ù…Ø§Ø¦ÙŠØ©
                if (!validateDataWatermark(data, user.uid)) {
                    console.warn('Watermark mismatch, possible data corruption');
                    return { isValid: false, data: null, isCorrupted: true };
                }
                
                return { isValid: true, data: data, isNew: false };
            }
            
            // Ø§Ù„Ù…Ø³ØªÙ†Ø¯ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ - Ù†Ø­ØªØ§Ø¬ Ù„Ù…Ø¹Ø±ÙØ© Ø§Ù„Ø³Ø¨Ø¨
            return { isValid: false, data: null, isNew: true };
            
        } catch (error) {
            console.error('Validation error:', error);
            return { isValid: false, data: null, error: error.message };
        }
    };
    
    // 6. Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯ Ø¨Ø´ÙƒÙ„ Ø¢Ù…Ù†
    const createNewUserSafe = async (user) => {
        const userDocRef = doc(db, "users", user.uid);
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ù…Ø²Ø¯ÙˆØ¬ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯ Ø­Ù‚Ù‹Ø§
        const isReallyNew = await isUserReallyNew(user);
        if (!isReallyNew) {
            throw new Error('User is not new - cannot create document');
        }
        
        // Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø¹ Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ù…Ø§Ø¦ÙŠØ©
        const watermark = createDataWatermark(user.uid);
        const customId = generateCustomId();
        
        const newUserData = {
            ...watermark,
            uid: user.uid,
            displayName: user.displayName || "Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯",
            photoURL: user.photoURL || 'https://via.placeholder.com/150',
            email: user.email || '',
            customId: customId,
            balance: 1000, // Ø±ØµÙŠØ¯ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ
            magicLevel: 1,
            wealthLevel: 1,
            magicXP: 0,
            wealthXP: 0,
            purchasedFrames: [],
            purchasedBadges: [],
            purchasedSvga: [],
            purchasedBubbles: [],
            activeFrame: null,
            activeBadges: [],
            friends: [],
            friendRequests: [],
            sentRequests: [],
            jewels: 0,
            stats: {
                totalGiftsSent: 0,
                totalGiftsReceived: 0,
                totalMessages: 0,
                loginCount: 0
            },
            timestamps: {
                createdAt: new Date().toISOString(),
                lastLogin: new Date().toISOString(),
                lastActive: new Date().toISOString()
            },
            security: {
                backupCodes: generateBackupCodes(),
                lastDeviceSignature: getDeviceSignature(),
                recoveryEmail: user.email || ''
            }
        };
        
        try {
            // Ø§Ø³ØªØ®Ø¯Ø§Ù… Batch Ù„Ù„ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø¢Ù…Ù†Ø©
            const batch = writeBatch(db);
            batch.set(userDocRef, newUserData);
            
            // Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„ Ù„Ù„Ù†Ø´Ø§Ø·
            const activityRef = doc(collection(db, "userActivities"));
            batch.set(activityRef, {
                userId: user.uid,
                type: 'account_created',
                timestamp: new Date().toISOString(),
                device: getDeviceSignature(),
                ipLocation: 'unknown' // ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© API Ù„Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹
            });
            
            await batch.commit();
            
            // Ø­ÙØ¸ Ø¹Ù„Ø§Ù…Ø© ÙÙŠ localStorage
            localStorage.setItem(USER_CREATION_FLAG, 'true');
            localStorage.setItem(`user_${user.uid}_created`, new Date().toISOString());
            
            return newUserData;
            
        } catch (error) {
            console.error('Failed to create user:', error);
            
            // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø¨Ø¯ÙˆÙ† batch
            try {
                await setDoc(userDocRef, newUserData, { merge: true });
                localStorage.setItem(USER_CREATION_FLAG, 'true');
                return newUserData;
            } catch (secondError) {
                throw secondError;
            }
        }
    };
    
    // 7. ØªØ­Ù‚Ù‚ Ø¹Ù…ÙŠÙ‚ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯
    const isUserReallyNew = async (user) => {
        // Ø§Ù„Ø·Ø¨Ù‚Ø© 1: ØªØ­Ù‚Ù‚ Ù…Ù† metadata
        const metadata = user.metadata;
        if (!metadata) return true;
        
        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ÙˆÙ‚Øª Ø¨ÙŠÙ† Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ¢Ø®Ø± ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ ÙƒØ¨ÙŠØ±Ù‹Ø§
        const created = new Date(metadata.creationTime);
        const lastSignIn = new Date(metadata.lastSignInTime);
        const diffHours = Math.abs(lastSignIn - created) / (1000 * 60 * 60);
        
        if (diffHours > 1) {
            return false; // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„ÙŠØ³ Ø¬Ø¯ÙŠØ¯Ù‹Ø§
        }
        
        // Ø§Ù„Ø·Ø¨Ù‚Ø© 2: ØªØ­Ù‚Ù‚ Ù…Ù† localStorage
        if (localStorage.getItem(`user_${user.uid}_created`)) {
            return false;
        }
        
        // Ø§Ù„Ø·Ø¨Ù‚Ø© 3: ØªØ­Ù‚Ù‚ Ù…Ù† Firestore (Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·)
        try {
            const activitiesQuery = query(
                collection(db, "userActivities"),
                where("userId", "==", user.uid),
                where("type", "==", "account_created")
            );
            
            const activitiesSnap = await getDocs(activitiesQuery);
            if (!activitiesSnap.empty) {
                return false;
            }
        } catch (error) {
            console.warn('Could not check activities:', error);
        }
        
        return true;
    };
    
    // 8. Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù…ÙŠØ©
    const restoreUserData = async (user) => {
        const userDocRef = doc(db, "users", user.uid);
        
        try {
            const docSnap = await getDoc(userDocRef);
            
            if (docSnap.exists()) {
                const data = docSnap.data();
                
                // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªØ§Ù„ÙØ© Ø£Ùˆ Ø¨Ø¯ÙˆÙ† Ø¹Ù„Ø§Ù…Ø© Ù…Ø§Ø¦ÙŠØ©
                if (!validateDataWatermark(data, user.uid)) {
                    console.warn('Attempting to restore corrupted data');
                    
                    // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù…Ù† Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ
                    const backupData = await getUserBackup(user.uid);
                    if (backupData && validateDataWatermark(backupData, user.uid)) {
                        await setDoc(userDocRef, backupData, { merge: true });
                        return backupData;
                    }
                    
                    // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙˆØ¬Ø¯ Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠØŒ Ù†Ø­ØªØ§Ø¬ Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                    return await rebuildUserData(user, data);
                }
                
                return data;
            }
            
            throw new Error('User document not found');
            
        } catch (error) {
            console.error('Restoration failed:', error);
            throw error;
        }
    };
    
    // 9. Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
    const createUserBackup = async (userId, data) => {
        try {
            // Ø­ÙØ¸ Ù…Ø­Ù„ÙŠ
            localStorage.setItem(`backup_${userId}`, JSON.stringify({
                data: data,
                timestamp: new Date().toISOString(),
                signature: getDeviceSignature()
            }));
            
            // Ø­ÙØ¸ ÙÙŠ Firestore (Ù…Ù†ÙØµÙ„)
            const backupRef = doc(db, "userBackups", userId);
            await setDoc(backupRef, {
                userId: userId,
                data: data,
                backupTimestamp: new Date().toISOString(),
                deviceSignature: getDeviceSignature()
            }, { merge: true });
            
        } catch (error) {
            console.warn('Backup failed:', error);
        }
    };
    
    // 10. Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ
    const getUserBackup = async (userId) => {
        try {
            // Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ù† Firestore Ø£ÙˆÙ„Ø§Ù‹
            const backupRef = doc(db, "userBackups", userId);
            const backupSnap = await getDoc(backupRef);
            
            if (backupSnap.exists()) {
                const backup = backupSnap.data();
                
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ø¬Ù‡Ø§Ø²
                if (backup.deviceSignature === getDeviceSignature()) {
                    return backup.data;
                }
            }
            
            // Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ù† localStorage
            const localBackup = localStorage.getItem(`backup_${userId}`);
            if (localBackup) {
                return JSON.parse(localBackup).data;
            }
            
        } catch (error) {
            console.warn('Backup retrieval failed:', error);
        }
        
        return null;
    };
    
    // 11. Ø¥Ø¹Ø§Ø¯Ø© Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ§Ù„ÙØ©
    const rebuildUserData = async (user, corruptedData) => {
        console.log('Rebuilding user data for:', user.uid);
        
        const watermark = createDataWatermark(user.uid);
        const customId = generateCustomId();
        
        // Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø© Ø¹Ù„Ù‰ Ø£ÙŠ Ø¨ÙŠØ§Ù†Ø§Øª ÙŠÙ…ÙƒÙ† Ø¥Ù†Ù‚Ø§Ø°Ù‡Ø§
        const rebuiltData = {
            ...watermark,
            uid: user.uid,
            displayName: corruptedData.displayName || user.displayName || "Ù…Ø³ØªØ®Ø¯Ù…",
            photoURL: corruptedData.photoURL || user.photoURL || 'https://via.placeholder.com/150',
            email: user.email || '',
            customId: corruptedData.customId || customId,
            balance: corruptedData.balance || 1000,
            magicLevel: corruptedData.magicLevel || 1,
            wealthLevel: corruptedData.wealthLevel || 1,
            magicXP: corruptedData.magicXP || 0,
            wealthXP: corruptedData.wealthXP || 0,
            purchasedFrames: corruptedData.purchasedFrames || [],
            purchasedBadges: corruptedData.purchasedBadges || [],
            purchasedSvga: corruptedData.purchasedSvga || [],
            purchasedBubbles: corruptedData.purchasedBubbles || [],
            activeFrame: corruptedData.activeFrame || null,
            activeBadges: corruptedData.activeBadges || [],
            friends: corruptedData.friends || [],
            friendRequests: corruptedData.friendRequests || [],
            sentRequests: corruptedData.sentRequests || [],
            jewels: corruptedData.jewels || 0,
            stats: {
                totalGiftsSent: corruptedData.stats?.totalGiftsSent || 0,
                totalGiftsReceived: corruptedData.stats?.totalGiftsReceived || 0,
                totalMessages: corruptedData.stats?.totalMessages || 0,
                loginCount: (corruptedData.stats?.loginCount || 0) + 1
            },
            timestamps: {
                createdAt: corruptedData.timestamps?.createdAt || new Date().toISOString(),
                lastLogin: new Date().toISOString(),
                lastActive: new Date().toISOString()
            }
        };
        
        try {
            const userDocRef = doc(db, "users", user.uid);
            await setDoc(userDocRef, rebuiltData, { merge: true });
            
            // Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ÙÙˆØ±Ù‹Ø§
            await createUserBackup(user.uid, rebuiltData);
            
            return rebuiltData;
            
        } catch (error) {
            console.error('Rebuild failed:', error);
            throw error;
        }
    };
    
    // 12. Ù…Ø¹Ø§Ù„Ø¬ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø­Ø³Ù†
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            try {
                console.log('User logged in:', user.uid);
                
                // Ø§Ù„Ø®Ø·ÙˆØ© 1: Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ø³ØªÙ†Ø¯ ÙˆØµØ­ØªÙ‡
                const validation = await validateUserDocument(user);
                
                if (validation.isValid) {
                    // âœ… Ø§Ù„Ù…Ø³ØªÙ†Ø¯ Ù…ÙˆØ¬ÙˆØ¯ ÙˆØµØ§Ù„Ø­
                    userData = validation.data;
                    
                    // ØªØ­Ø¯ÙŠØ« Ø¢Ø®Ø± ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„
                    await updateDoc(doc(db, "users", user.uid), {
                        'timestamps.lastLogin': new Date().toISOString(),
                        'timestamps.lastActive': new Date().toISOString(),
                        'stats.loginCount': increment(1)
                    });
                    
                    // Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
                    await createUserBackup(user.uid, userData);
                    
                } else if (validation.isNew) {
                    // ğŸ“ Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯ Ø­Ù‚ÙŠÙ‚ÙŠ
                    try {
                        userData = await createNewUserSafe(user);
                        console.log('New user created:', userData.customId);
                    } catch (createError) {
                        console.error('Failed to create new user:', createError);
                        
                        // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©
                        try {
                            userData = await restoreUserData(user);
                            console.log('User data restored from backup');
                        } catch (restoreError) {
                            console.error('Restoration failed:', restoreError);
                            
                            // Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø·Ø§Ø±Ø¦
                            userData = await emergencyUserCreation(user);
                        }
                    }
                    
                } else if (validation.isCorrupted) {
                    // âš ï¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªØ§Ù„ÙØ©
                    console.warn('Data corruption detected, attempting restore...');
                    userData = await restoreUserData(user);
                    
                } else {
                    // âŒ Ø­Ø§Ù„Ø© ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙØ©
                    throw new Error('Unknown user state');
                }
                
                // âœ… Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª - Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©
                
                // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙÙŠ ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                setupUserSnapshot(user.uid);
                
                // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
                await Promise.all([
                    loadBanner(),
                    loadGlobalData(),
                    loadRooms()
                ]);
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
                await updateUI();
                
                // ØªØ­Ù…ÙŠÙ„ Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡
                await Promise.all([
                    loadFriendRequests(),
                    loadFriends()
                ]);
                
                // ØªØ­Ø¯ÙŠØ« Ù†Ø´Ø· Ø¯ÙˆØ±ÙŠ
                startActivityTracker(user.uid);
                
            } catch (error) {
                console.error('Critical auth error:', error);
                
                // Ø­Ø§Ù„Ø© Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ - Ø¹Ø±Ø¶ ÙˆØ§Ø¬Ù‡Ø© Ù…Ø­Ø¯ÙˆØ¯Ø©
                showEmergencyInterface(user);
                
                // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„
                setTimeout(() => {
                    location.reload();
                }, 5000);
            }
            
        } else {
            // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
            cleanup();
            window.location.href = "index.html";
        }
    });
    
    // 13. Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø·Ø§Ø±Ø¦
    const emergencyUserCreation = async (user) => {
        const watermark = createDataWatermark(user.uid);
        const customId = generateCustomId();
        
        const emergencyData = {
            ...watermark,
            uid: user.uid,
            displayName: user.displayName || "Ù…Ø³ØªØ®Ø¯Ù…",
            photoURL: user.photoURL || 'https://via.placeholder.com/150',
            email: user.email || '',
            customId: customId,
            balance: 1000,
            magicLevel: 1,
            wealthLevel: 1,
            magicXP: 0,
            wealthXP: 0,
            purchasedFrames: [],
            purchasedBadges: [],
            purchasedSvga: [],
            purchasedBubbles: [],
            activeFrame: null,
            activeBadges: [],
            friends: [],
            friendRequests: [],
            sentRequests: [],
            jewels: 0,
            stats: {
                totalGiftsSent: 0,
                totalGiftsReceived: 0,
                totalMessages: 0,
                loginCount: 1
            },
            timestamps: {
                createdAt: new Date().toISOString(),
                lastLogin: new Date().toISOString(),
                lastActive: new Date().toISOString()
            },
            emergencyCreated: true
        };
        
        try {
            const userDocRef = doc(db, "users", user.uid);
            await setDoc(userDocRef, emergencyData, { merge: true });
            
            // Ø­ÙØ¸ Ù…Ø­Ù„ÙŠ ÙƒØ¥Ø¬Ø±Ø§Ø¡ Ø·Ø§Ø±Ø¦
            localStorage.setItem(`emergency_${user.uid}`, JSON.stringify(emergencyData));
            
            return emergencyData;
        } catch (error) {
            console.error('Emergency creation failed:', error);
            
            // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© ÙÙ‚Ø·
            emergencyData.localOnly = true;
            return emergencyData;
        }
    };
    
    // 14. Ø¥Ø¹Ø¯Ø§Ø¯ ØªØªØ¨Ø¹ Ø§Ù„Ù†Ø´Ø§Ø·
    const startActivityTracker = (userId) => {
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ø´Ø§Ø· ÙƒÙ„ Ø¯Ù‚ÙŠÙ‚Ø©
        setInterval(async () => {
            if (auth.currentUser) {
                try {
                    await updateDoc(doc(db, "users", userId), {
                        'timestamps.lastActive': new Date().toISOString()
                    });
                } catch (error) {
                    console.warn('Activity update failed:', error);
                }
            }
        }, 60000);
        
        // ØªØ­Ø¯ÙŠØ« Ø¹Ù†Ø¯ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØµÙØ­Ø©
        window.addEventListener('beforeunload', async () => {
            if (auth.currentUser) {
                try {
                    await updateDoc(doc(db, "users", userId), {
                        'timestamps.lastActive': new Date().toISOString()
                    });
                } catch (error) {
                    // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø­ÙØ¸ Ù…Ø­Ù„ÙŠÙ‹Ø§
                    localStorage.setItem(`lastActive_${userId}`, new Date().toISOString());
                }
            }
        });
    };
    
    // 15. ÙˆØ¸Ø§Ø¦Ù Ù…Ø³Ø§Ø¹Ø¯Ø©
    function generateCustomId() {
        const prefix = 'AFN';
        const timestamp = Date.now().toString(36).slice(-4).toUpperCase();
        const random = Math.random().toString(36).slice(2, 6).toUpperCase();
        return `${prefix}${timestamp}${random}`;
    }
    
    function generateBackupCodes() {
        const codes = [];
        for (let i = 0; i < 5; i++) {
            codes.push(Math.random().toString(36).slice(2, 10).toUpperCase());
        }
        return codes;
    }
    
    function cleanup() {
        // ØªÙ†Ø¸ÙŠÙ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø´ØºÙ„Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©
        Object.keys(activeSvgaPlayers).forEach(id => {
            try {
                activeSvgaPlayers[id].player.clear();
            } catch (e) {}
        });
        activeSvgaPlayers = {};
        
        // Ø¥Ù„ØºØ§Ø¡ Ø§Ø´ØªØ±Ø§ÙƒØ§Øª Firestore
        if (userUnsubscribe) {
            userUnsubscribe();
            userUnsubscribe = null;
        }
        
        if (chatUnsubscribe) {
            chatUnsubscribe();
            chatUnsubscribe = null;
        }
    }
    
    // 16. ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø·ÙˆØ§Ø±Ø¦
    function showEmergencyInterface(user) {
        document.body.innerHTML = `
            <div class="min-h-screen flex items-center justify-center bg-gray-50 p-4">
                <div class="glass-deep rounded-3xl p-8 max-w-md text-center">
                    <div class="text-red-500 mb-4">
                        <i data-lucide="alert-triangle" class="w-16 h-16 mx-auto"></i>
                    </div>
                    <h2 class="text-2xl font-bold mb-4">Ù…Ø´ÙƒÙ„Ø© ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h2>
                    <p class="text-gray-600 mb-6">
                        Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø³Ø§Ø¨Ùƒ. Ø¬Ø§Ø±ÙŠ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø¥ØµÙ„Ø§Ø­ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§...
                    </p>
                    <div class="loader mx-auto mb-6"></div>
                    <p class="text-sm text-gray-500">
                        Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${user.email || user.uid.substring(0, 8)}<br>
                        Ø¥Ø°Ø§ Ø§Ø³ØªÙ…Ø±Øª Ø§Ù„Ù…Ø´ÙƒÙ„Ø©ØŒ Ø±Ø§Ø³Ù„ Ø§Ù„Ø¯Ø¹Ù… Ù…Ø¹ Ø§Ù„Ù€ ID: ${user.uid}
                    </p>
                </div>
            </div>
        `;
        lucide.createIcons();
    }
    
    // 17. Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ø´ØªØ±Ø§Ùƒ Ø¢Ù…Ù†
    let userUnsubscribe = null;
    
    function setupUserSnapshot(uid) {
        if (userUnsubscribe) {
            userUnsubscribe();
        }
        
        const userDocRef = doc(db, "users", uid);
        userUnsubscribe = onSnapshot(userDocRef, (docSnap) => {
            if (docSnap.exists()) {
                const data = docSnap.data();
                
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ù…Ø§Ø¦ÙŠØ© Ù‚Ø¨Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«
                if (validateDataWatermark(data, uid)) {
                    userData = data;
                    updateUI();
                    
                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ
                    createUserBackup(uid, data).catch(() => {});
                } else {
                    console.warn('Received invalid data from snapshot');
                }
            }
        }, (error) => {
            console.error('Snapshot error:', error);
            
            // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© ÙƒÙ†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
            const localBackup = localStorage.getItem(`backup_${uid}`);
            if (localBackup) {
                try {
                    const backup = JSON.parse(localBackup);
                    if (validateDataWatermark(backup.data, uid)) {
                        userData = backup.data;
                        updateUI();
                    }
                } catch (e) {}
            }
        });
    }
    
    // 18. Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø°Ø§ØªÙŠØ©
    const selfMonitor = {
        lastBalance: null,
        lastLevels: null,
        
        checkAnomalies: (newData) => {
            const anomalies = [];
            
            if (selfMonitor.lastBalance !== null) {
                const balanceDiff = newData.balance - selfMonitor.lastBalance;
                
                // ØªØºÙŠÙŠØ± ØºÙŠØ± Ø·Ø¨ÙŠØ¹ÙŠ ÙÙŠ Ø§Ù„Ø±ØµÙŠØ¯
                if (Math.abs(balanceDiff) > 100000 && balanceDiff < 0) {
                    anomalies.push(`Large balance decrease: ${balanceDiff}`);
                }
                
                // Ø±ØµÙŠØ¯ Ø³Ø§Ù„Ø¨
                if (newData.balance < 0) {
                    anomalies.push('Negative balance detected');
                }
            }
            
            if (selfMonitor.lastLevels) {
                const magicDiff = newData.magicLevel - selfMonitor.lastLevels.magic;
                const wealthDiff = newData.wealthLevel - selfMonitor.lastLevels.wealth;
                
                // ØªØ±Ù‚ÙŠØ© ØºÙŠØ± Ø·Ø¨ÙŠØ¹ÙŠØ©
                if (magicDiff > 5 || wealthDiff > 5) {
                    anomalies.push(`Abnormal level increase: Magic +${magicDiff}, Wealth +${wealthDiff}`);
                }
                
                // Ø§Ù†Ø®ÙØ§Ø¶ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ (ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­)
                if (magicDiff < 0 || wealthDiff < 0) {
                    anomalies.push('Level decrease detected - possible corruption');
                }
            }
            
            // Ø­ÙØ¸ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø­Ø§Ù„ÙŠØ©
            selfMonitor.lastBalance = newData.balance;
            selfMonitor.lastLevels = {
                magic: newData.magicLevel,
                wealth: newData.wealthLevel
            };
            
            // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª
            if (anomalies.length > 0) {
                console.warn('Anomalies detected:', anomalies);
                
                // Ø­ÙØ¸ ÙÙŠ Firestore Ù„Ù„ØªØ¯Ù‚ÙŠÙ‚
                try {
                    const auditRef = doc(collection(db, "securityAudits"));
                    setDoc(auditRef, {
                        userId: auth.currentUser?.uid,
                        anomalies: anomalies,
                        timestamp: new Date().toISOString(),
                        dataSnapshot: newData
                    });
                } catch (e) {}
            }
            
            return anomalies;
        }
    };
    
    // 19. ØªØ¹Ø¯ÙŠÙ„ Ø¯Ø§Ù„Ø© updateUI Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©
    async function updateUI() {
        if (!auth.currentUser || !userData) return;
        
        try {
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø´Ø°ÙˆØ°Ø§Øª
            const anomalies = selfMonitor.checkAnomalies(userData);
            if (anomalies.length > 0) {
                console.warn('UI update blocked due to anomalies');
                return;
            }
            
            // ... (Ø¨Ù‚ÙŠØ© ÙƒÙˆØ¯ updateUI ÙƒÙ…Ø§ Ù‡Ùˆ) ...
            
        } catch (error) {
            console.error('UI update error:', error);
        }
    }
    
    // 20. ØªØ¹Ø¯ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø¯ÙˆØ§Ù„ Ø§Ù„ÙƒØªØ§Ø¨Ø© Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ù…Ø§ÙŠØ©
    window.buyItem = async (type, id, price) => {
        if (!auth.currentUser) return;
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±ØµÙŠØ¯
        if (userData.balance < price) {
            alert('Ø±ØµÙŠØ¯Ùƒ ØºÙŠØ± ÙƒØ§ÙÙ!');
            return;
        }
        
        // Ù…Ù†Ø¹ Ø§Ù„Ø´Ø±Ø§Ø¡ Ø§Ù„Ù…Ø²Ø¯ÙˆØ¬
        const fieldMap = {
            'frames': 'purchasedFrames',
            'badges': 'purchasedBadges',
            'svga': 'purchasedSvga',
            'bubbles': 'purchasedBubbles'
        };
        
        const field = fieldMap[type];
        if (userData[field]?.some(item => item.id === id)) {
            alert('Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù†ØµØ± Ù…Ù…Ù„ÙˆÙƒ Ù…Ø³Ø¨Ù‚Ù‹Ø§!');
            return;
        }
        
        try {
            // Ø§Ø³ØªØ®Ø¯Ø§Ù… Batch Ù„Ù„ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø¢Ù…Ù†Ø©
            const batch = writeBatch(db);
            const userRef = doc(db, "users", auth.currentUser.uid);
            
            // 1. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯
            batch.update(userRef, {
                balance: increment(-price)
            });
            
            // 2. Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù†ØµØ±
            batch.update(userRef, {
                [field]: arrayUnion({
                    id: id,
                    purchasedAt: new Date().toISOString(),
                    price: price,
                    transactionId: `TXN_${Date.now()}_${Math.random().toString(36).slice(2)}`
                })
            });
            
            // 3. ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©
            const transactionRef = doc(collection(db, "transactions"));
            batch.set(transactionRef, {
                userId: auth.currentUser.uid,
                type: 'purchase',
                itemType: type,
                itemId: id,
                amount: -price,
                balanceAfter: userData.balance - price,
                timestamp: new Date().toISOString(),
                device: getDeviceSignature()
            });
            
            await batch.commit();
            
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ØªØ¬Ø±
            loadStoreItems(type);
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ
            createUserBackup(auth.currentUser.uid, {
                ...userData,
                balance: userData.balance - price,
                [field]: [...(userData[field] || []), {
                    id: id,
                    purchasedAt: new Date().toISOString()
                }]
            });
            
        } catch (error) {
            console.error('Purchase failed:', error);
            alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø´Ø±Ø§Ø¡ØŒ Ù„Ù… ÙŠØªÙ… Ø®ØµÙ… Ø§Ù„Ø±ØµÙŠØ¯');
        }
    };
    
    // ... (Ø¨Ù‚ÙŠØ© Ø§Ù„Ø¯ÙˆØ§Ù„ Ù…Ø¹ Ù†ÙØ³ Ø§Ù„Ù†Ù…Ø· Ù…Ù† Ø§Ù„Ø­Ù…Ø§ÙŠØ©) ...

    // ================= ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ =================
    
    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
    async function loadGlobalData() {
        try {
            const collections = [
                'frames', 'badges', 'svgaItems', 'gifts', 'luckGifts', 
                'magicLevels', 'wealthLevels', 'bubbles', 'levelRequirements'
            ];
            
            const promises = collections.map(async (col) => {
                const snap = await getDocs(collection(db, col));
                if (col.includes('Levels')) {
                    storeData[col] = {};
                    snap.docs.forEach(d => storeData[col][d.id] = d.data());
                } else {
                    storeData[col] = snap.docs.map(d => ({id: d.id, ...d.data()}));
                }
            });
            
            await Promise.all(promises);
            
        } catch (error) {
            console.error('Error loading global data:', error);
        }
    }
    
    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨Ù†Ø±
    async function loadBanner() {
        try {
            const bDoc = await getDoc(doc(db, "appData", "banner"));
            const container = document.getElementById('homeBanner');
            if (bDoc.exists()) {
                const b = bDoc.data();
                container.innerHTML = `
                    <div class="absolute inset-0 bg-gradient-to-r ${b.gradient} opacity-80"></div>
                    <img src="${b.image}" class="absolute inset-0 w-full h-full object-cover opacity-50 mix-blend-overlay">
                `;
            }
        } catch (error) {
            console.error('Error loading banner:', error);
        }
    }
    
    // ... (Ø¨Ù‚ÙŠØ© Ø§Ù„Ø¯ÙˆØ§Ù„ ÙƒÙ…Ø§ Ù‡ÙŠ Ù…Ø¹ ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø·ÙÙŠÙØ© Ù„Ù„ØªÙˆØ§ÙÙ‚) ...

</script>
</body>
</html>
