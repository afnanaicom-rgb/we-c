<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Afnan AI - Ø§Ù„Ù…Ø­ÙØ¸Ø© ÙˆØ§Ù„Ø´Ø­Ù†</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: 'Noto Sans Arabic', sans-serif; }
        body, html { height: 100%; margin: 0; background-color: #f8f9fa; color: #1a1a1a; overflow-x: hidden; }
        
        .view-screen { position: absolute; inset: 0; width: 100%; height: 100%; background: #f8f9fa; display: none; flex-direction: column; z-index: 10; padding-top: 70px; overflow-y: auto; }
        .view-screen.active { display: flex; }

        .app-header { position: fixed; top: 0; right: 0; left: 0; height: 70px; background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(20px); border-bottom: 1px solid #eee; display: flex; align-items: center; justify-content: space-between; padding: 0 1rem; z-index: 1000; }

        /* Ø¨Ø±ÙˆÙØ§ÙŠÙ„ Ø§Ù„Ø³Ø§ÙŠØ¯Ø¨Ø§Ø± */
        .profile-container { position: relative; width: 100px; height: 100px; margin: 0 auto; }
        .avatar-img { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; position: absolute; top: 10px; left: 10px; z-index: 1; }
        .user-frame { position: absolute; inset: 0; z-index: 2; width: 100%; height: 100%; pointer-events: none; }
        
        .level-badge { font-size: 10px; font-weight: 800; padding: 2px 8px; border-radius: 10px; color: white; margin: 2px; }
        .wealth-lv { background: linear-gradient(to left, #f59e0b, #d97706); }
        .magic-lv { background: linear-gradient(to left, #8b5cf6, #6d28d9); }

        .badges-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; padding: 10px; width: 100%; max-width: 200px; margin: 0 auto; }
        .badge-slot { width: 40px; height: 40px; background: #f3f4f6; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 20px; border: 1px dashed #ccc; }
        .badge-slot.has-badge { border: 2px solid #f59e0b; background: linear-gradient(135deg, #fff5e6, #ffedd5); }

        /* ØªØµÙ…ÙŠÙ… ÙƒØ±Øª Ø§Ù„Ù…Ø­ÙØ¸Ø© */
        .wallet-card { background: linear-gradient(135deg, #1e293b, #0f172a); color: white; border-radius: 30px; padding: 30px; margin: 20px; position: relative; overflow: hidden; box-shadow: 0 20px 40px rgba(0,0,0,0.1); }
        .wallet-card::after { content: ''; position: absolute; top: -50%; right: -50%; width: 200px; height: 200px; background: rgba(245, 158, 11, 0.1); border-radius: 50%; }

        .buy-card { background: white; border: 1px solid #eee; border-radius: 20px; padding: 15px; display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; transition: 0.2s; }
        .buy-card:active { transform: scale(0.98); border-color: #f59e0b; }

        .sidebar { position: fixed; top: 0; right: -300px; width: 300px; height: 100%; background: white; z-index: 4000; transition: 0.4s; border-left: 1px solid #eee; }
        .sidebar.open { right: 0; }
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.3); z-index: 2500; display: none; backdrop-filter: blur(4px); }
        .overlay.active { display: block; }

        /* Ø§Ù„Ø¨Ø­Ø« */
        .search-container { position: fixed; top: 70px; right: 0; left: 0; background: white; padding: 1rem; border-bottom: 1px solid #eee; z-index: 999; display: none; }
        .search-container.active { display: block; }
        .search-input { width: 100%; padding: 12px 16px; border: 2px solid #f3f4f6; border-radius: 12px; font-size: 14px; background: #fafafa; }

        /* Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…ØªØ¬Ø± */
        .store-item { background: white; border-radius: 16px; padding: 16px; text-align: center; border: 1px solid #eee; transition: 0.2s; }
        .store-item:active { transform: scale(0.98); }
        .store-item.owned { opacity: 0.6; }
        .store-item.equipped { border: 2px solid #10b981; }
    </style>
</head>
<body>

    <div id="toastContainer" class="fixed bottom-5 left-1/2 -translate-x-1/2 z-[11000]"></div>

    <div id="loginPage" class="fixed inset-0 bg-white z-[10000] flex flex-col items-center justify-center p-6">
        <img src="https://files.manuscdn.com/user_upload_by_module/session_file/310519663174655187/mcieZCLEOIrmCjBq.png" class="w-24 mb-6">
        <button onclick="loginWithGoogle()" class="w-full max-w-xs flex items-center justify-center gap-3 border p-4 rounded-2xl font-bold shadow-sm">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-5">
            Ø¯Ø®ÙˆÙ„ Ø¹Ø¨Ø± Ø¬ÙˆØ¬Ù„
        </button>
    </div>

    <div id="main-app" style="display: none;">
        <header class="app-header">
            <button onclick="toggleSidebar()" class="p-2 bg-gray-50 rounded-lg"><i data-lucide="menu"></i></button>
            <div class="font-bold" id="view-title">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
            <div class="flex items-center gap-2">
                <button onclick="toggleSearch()" class="p-2 bg-gray-50 rounded-lg"><i data-lucide="search"></i></button>
                <div class="flex items-center gap-2 bg-orange-50 px-3 py-1 rounded-full cursor-pointer" onclick="switchView('wallet')">
                    <span id="header-balance" class="text-xs font-bold text-orange-600">0</span>
                    <span>ğŸ’°</span>
                </div>
            </div>
        </header>

        <!-- Ø´Ø±ÙŠØ· Ø§Ù„Ø¨Ø­Ø« -->
        <div id="searchContainer" class="search-container">
            <input type="text" id="searchInput" class="search-input" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø±Ù‚Ù… ID...">
            <div id="searchResults" class="mt-3 max-h-60 overflow-y-auto"></div>
        </div>

        <div id="sidebar" class="sidebar overflow-y-auto">
            <div class="p-6 text-center border-b">
                <div class="profile-container">
                    <img id="userAvatar" src="https://i.pravatar.cc/150" class="avatar-img">
                    <img id="activeFrame" src="" class="user-frame" style="display: none;">
                </div>
                <div id="userName" class="font-bold mt-2 text-gray-800">ØªØ­Ù…ÙŠÙ„...</div>
                <div class="flex justify-center gap-1 my-2">
                    <span id="wealth-lv" class="level-badge wealth-lv">Ø«Ø±ÙˆØ© LV 1</span>
                    <span id="magic-lv" class="level-badge magic-lv">Ø³Ø­Ø± LV 1</span>
                </div>
                <div class="text-[10px] text-gray-400 font-bold mb-3">ID: <span id="userID">88291034</span></div>
                
                <div class="badges-grid" id="userBadges">
                    <div class="badge-slot"></div>
                    <div class="badge-slot"></div>
                    <div class="badge-slot"></div>
                    <div class="badge-slot"></div>
                </div>
            </div>
            
            <div class="p-4">
                <div class="flex items-center gap-4 p-4 hover:bg-gray-50 rounded-xl cursor-pointer" onclick="switchView('rooms')"><i data-lucide="home"></i> Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
                <div class="flex items-center gap-4 p-4 hover:bg-gray-50 rounded-xl cursor-pointer" onclick="switchView('wallet')"><i data-lucide="wallet"></i> Ø§Ù„Ù…Ø­ÙØ¸Ø©</div>
                <div class="flex items-center gap-4 p-4 hover:bg-gray-50 rounded-xl cursor-pointer" onclick="switchView('store')"><i data-lucide="shopping-bag"></i> Ø§Ù„Ù…ØªØ¬Ø±</div>
                <div class="flex items-center gap-4 p-4 hover:bg-gray-50 rounded-xl cursor-pointer text-red-500" onclick="logout()"><i data-lucide="log-out"></i> Ø®Ø±ÙˆØ¬</div>
            </div>
        </div>

        <div id="view-rooms" class="view-screen active">
            <div class="p-4 grid grid-cols-2 gap-4" id="roomsContainer"></div>
        </div>

        <div id="view-wallet" class="view-screen">
            <div class="wallet-card">
                <div class="text-[10px] uppercase tracking-widest text-gray-400 font-bold mb-2">Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ</div>
                <div class="flex items-baseline gap-2">
                    <span id="wallet-balance-big" class="text-4xl font-bold">0</span>
                    <span class="text-orange-500 font-bold">ğŸ’°</span>
                </div>
            </div>

            <div class="px-5">
                <h3 class="font-bold text-gray-800 mb-4 px-2">Ø¨Ø§Ù‚Ø§Øª Ø§Ù„Ø´Ø­Ù†</h3>
                
                <div class="buy-card">
                    <div>
                        <div class="font-bold text-gray-800">Ø¨Ø§Ù‚Ø© Ø§Ù„Ù…Ø¨ØªØ¯Ø¦</div>
                        <div class="text-[11px] text-orange-500 font-bold">+27,000 Ø¹Ù…Ù„Ø©</div>
                    </div>
                    <button onclick="recharge(27000, 1)" class="bg-orange-500 text-white px-6 py-2 rounded-xl font-bold text-sm shadow-lg shadow-orange-100">1$ Ø´Ø±Ø§Ø¡</button>
                </div>

                <div class="buy-card">
                    <div>
                        <div class="font-bold text-gray-800">Ø¨Ø§Ù‚Ø© Ø§Ù„Ù†Ø®Ø¨Ø©</div>
                        <div class="text-[11px] text-orange-500 font-bold">+150,000 Ø¹Ù…Ù„Ø©</div>
                    </div>
                    <button onclick="recharge(150000, 5)" class="bg-gray-800 text-white px-6 py-2 rounded-xl font-bold text-sm">5$ Ø´Ø±Ø§Ø¡</button>
                </div>
            </div>
        </div>

        <div id="view-store" class="view-screen">
            <div class="flex justify-center gap-2 p-4">
                <button class="px-4 py-2 bg-gray-100 rounded-xl text-xs font-bold" onclick="filterStore('frames')">Ø¥Ø·Ø§Ø±Ø§Øª</button>
                <button class="px-4 py-2 bg-gray-100 rounded-xl text-xs font-bold" onclick="filterStore('badges')">Ø´Ø§Ø±Ø§Øª</button>
            </div>
            <div id="storeItems" class="grid grid-cols-2 gap-4 p-4"></div>
        </div>

        <div id="overlay" class="overlay" onclick="toggleSidebar()"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { 
            getAuth, 
            signInWithPopup, 
            GoogleAuthProvider, 
            onAuthStateChanged, 
            signOut 
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            getDoc, 
            updateDoc, 
            collection, 
            query, 
            where, 
            getDocs,
            increment
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBnmqWRY6lV54meFvO89QeXwtd28w81FcY",
            authDomain: "rtx3090-28439.firebaseapp.com",
            projectId: "rtx3090-28439",
            storageBucket: "rtx3090-28439.firebasestorage.app",
            messagingSenderId: "178612030690",
            appId: "1:178612030690:web:883189ced2ed3a78e3e2bb"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù…ØªØ¬Ø±
        const storeItems = {
            frames: [
                { id: 'frame1', name: 'Ø¥Ø·Ø§Ø± Ø°Ù‡Ø¨ÙŠ', price: 5000, type: 'frame', image: 'https://cdn-icons-png.flaticon.com/512/3135/3135715.png' },
                { id: 'frame2', name: 'Ø¥Ø·Ø§Ø± ÙØ¶ÙŠ', price: 3000, type: 'frame', image: 'https://cdn-icons-png.flaticon.com/512/3135/3135715.png' },
                { id: 'frame3', name: 'Ø¥Ø·Ø§Ø± Ù…Ø§Ø³ÙŠ', price: 10000, type: 'frame', image: 'https://cdn-icons-png.flaticon.com/512/3135/3135715.png' },
                { id: 'frame4', name: 'Ø¥Ø·Ø§Ø± Ø³Ø­Ø±ÙŠ', price: 15000, type: 'frame', image: 'https://cdn-icons-png.flaticon.com/512/3135/3135715.png' }
            ],
            badges: [
                { id: 'badge1', name: 'Ø´Ø§Ø±Ø© Ø§Ù„Ù…Ù„Ùƒ', price: 1000, type: 'badge', icon: 'ğŸ‘‘' },
                { id: 'badge2', name: 'Ø´Ø§Ø±Ø© Ø§Ù„Ù†Ø¬Ù…', price: 800, type: 'badge', icon: 'â­' },
                { id: 'badge3', name: 'Ø´Ø§Ø±Ø© Ø§Ù„Ù†Ø§Ø±', price: 1200, type: 'badge', icon: 'ğŸ”¥' },
                { id: 'badge4', name: 'Ø´Ø§Ø±Ø© Ø§Ù„Ø³Ø­Ø±', price: 2000, type: 'badge', icon: 'âœ¨' },
                { id: 'badge5', name: 'Ø´Ø§Ø±Ø© Ø§Ù„ØªØ§Ø¬', price: 1500, type: 'badge', icon: 'ğŸ‘‘' },
                { id: 'badge6', name: 'Ø´Ø§Ø±Ø© Ø§Ù„Ù‚Ù„Ø¨', price: 700, type: 'badge', icon: 'â¤ï¸' },
                { id: 'badge7', name: 'Ø´Ø§Ø±Ø© Ø§Ù„Ø¯Ø±Ø¹', price: 2500, type: 'badge', icon: 'ğŸ›¡ï¸' }
            ]
        };

        window.loginWithGoogle = async () => {
            try {
                const provider = new GoogleAuthProvider();
                const result = await signInWithPopup(auth, provider);
                const user = result.user;
                
                // Ø¥Ù†Ø´Ø§Ø¡/ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                await initUserData(user);
                
            } catch (error) {
                console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„:", error);
                showToast("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ³Ø¬ÙŠÙ„");
            }
        };

        async function initUserData(user) {
            const userRef = doc(db, "users", user.uid);
            const userSnap = await getDoc(userRef);
            
            if (!userSnap.exists()) {
                // Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
                await setDoc(userRef, {
                    uid: user.uid,
                    displayName: user.displayName,
                    photoURL: user.photoURL,
                    balance: 0,
                    wealthLv: 1,
                    magicLv: 1,
                    purchasedFrames: [],
                    purchasedBadges: [],
                    activeFrame: null,
                    activeBadges: [],
                    createdAt: new Date()
                });
            }
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
            loadUserData(user.uid);
        }

        async function loadUserData(uid) {
            const userRef = doc(db, "users", uid);
            const userSnap = await getDoc(userRef);
            
            if (userSnap.exists()) {
                const userData = userSnap.data();
                updateUI(userData);
            }
        }

        window.logout = () => signOut(auth);

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('main-app').style.display = 'block';
                await loadUserData(user.uid);
                initApp();
            } else {
                document.getElementById('loginPage').style.display = 'flex';
                document.getElementById('main-app').style.display = 'none';
            }
        });

        // ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø´Ø­Ù†
        window.recharge = async (amount, dollars) => {
            const user = auth.currentUser;
            if (!user) return;
            
            try {
                const userRef = doc(db, "users", user.uid);
                await updateDoc(userRef, {
                    balance: increment(amount),
                    wealthLv: increment(dollars)
                });
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                await loadUserData(user.uid);
                showToast(`ğŸ’ ØªÙ… Ø´Ø­Ù† ${amount.toLocaleString()} Ø¹Ù…Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­!`);
            } catch (error) {
                console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø´Ø­Ù†:", error);
                showToast("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø´Ø­Ù†");
            }
        };

        // ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø´Ø±Ø§Ø¡
        window.buyItem = async (item) => {
            const user = auth.currentUser;
            if (!user) return;
            
            try {
                const userRef = doc(db, "users", user.uid);
                const userSnap = await getDoc(userRef);
                const userData = userSnap.data();
                
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±ØµÙŠØ¯
                if (userData.balance < item.price) {
                    showToast("Ø±ØµÙŠØ¯Ùƒ ØºÙŠØ± ÙƒØ§ÙÙŠ Ù„Ù„Ø´Ø±Ø§Ø¡");
                    return;
                }
                
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¹Ù†ØµØ± Ù…Ù…Ù„ÙˆÙƒ Ø¨Ø§Ù„ÙØ¹Ù„
                if (item.type === 'frame') {
                    if (userData.purchasedFrames.includes(item.id)) {
                        showToast("Ù„Ø¯ÙŠÙƒ Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø·Ø§Ø± Ø¨Ø§Ù„ÙØ¹Ù„");
                        return;
                    }
                } else if (item.type === 'badge') {
                    if (userData.purchasedBadges.includes(item.id)) {
                        showToast("Ù„Ø¯ÙŠÙƒ Ù‡Ø°Ù‡ Ø§Ù„Ø´Ø§Ø±Ø© Ø¨Ø§Ù„ÙØ¹Ù„");
                        return;
                    }
                }
                
                // Ø®ØµÙ… Ø§Ù„Ø³Ø¹Ø± ÙˆØ¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù†ØµØ±
                let updates = {
                    balance: increment(-item.price)
                };
                
                if (item.type === 'frame') {
                    updates.purchasedFrames = [...userData.purchasedFrames, item.id];
                    updates.activeFrame = item.id; // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø·Ø§Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
                } else if (item.type === 'badge') {
                    updates.purchasedBadges = [...userData.purchasedBadges, item.id];
                    
                    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø´Ø§Ø±Ø© Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ù…ÙƒØ§Ù†
                    if (userData.activeBadges.length < 4) {
                        updates.activeBadges = [...userData.activeBadges, item.id];
                    }
                }
                
                await updateDoc(userRef, updates);
                await loadUserData(user.uid);
                showToast(`âœ… ØªÙ… Ø´Ø±Ø§Ø¡ ${item.name} Ø¨Ù†Ø¬Ø§Ø­!`);
                
            } catch (error) {
                console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø´Ø±Ø§Ø¡:", error);
                showToast("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø´Ø±Ø§Ø¡");
            }
        };

        // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
        window.searchUsers = async () => {
            const searchInput = document.getElementById('searchInput').value.trim();
            const resultsContainer = document.getElementById('searchResults');
            
            if (searchInput.length < 3) {
                resultsContainer.innerHTML = '<div class="text-center text-gray-500 py-4">Ø§ÙƒØªØ¨ 3 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„</div>';
                return;
            }
            
            try {
                const usersRef = collection(db, "users");
                const q = query(usersRef, where("uid", "==", searchInput));
                const querySnapshot = await getDocs(q);
                
                resultsContainer.innerHTML = '';
                
                if (querySnapshot.empty) {
                    resultsContainer.innerHTML = '<div class="text-center text-gray-500 py-4">Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ø³ØªØ®Ø¯Ù…</div>';
                    return;
                }
                
                querySnapshot.forEach((doc) => {
                    const user = doc.data();
                    resultsContainer.innerHTML += `
                        <div class="bg-white p-4 rounded-xl border mb-2 flex items-center gap-3">
                            <img src="${user.photoURL || 'https://i.pravatar.cc/150'}" class="w-10 h-10 rounded-full">
                            <div class="flex-1">
                                <div class="font-bold text-sm">${user.displayName}</div>
                                <div class="text-xs text-gray-500">ID: ${user.uid}</div>
                                <div class="text-xs mt-1">
                                    <span class="text-orange-500">ğŸ’° ${user.balance || 0}</span>
                                    <span class="mx-2">â€¢</span>
                                    <span class="text-purple-500">Ø³Ø­Ø±: ${user.magicLv || 1}</span>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
            } catch (error) {
                console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø«:", error);
                resultsContainer.innerHTML = '<div class="text-center text-red-500 py-4">Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø«</div>';
            }
        };
    </script>

    <script>
        let currentUserData = null;

        function initApp() {
            renderRooms();
            filterStore('frames');
            lucide.createIcons();
            
            // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ø­Ø¯Ø« Ù„Ù„Ø¨Ø­Ø« Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ÙƒØªØ§Ø¨Ø©
            document.getElementById('searchInput').addEventListener('input', debounce(searchUsers, 500));
        }

        function updateUI(userData) {
            currentUserData = userData;
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
            document.getElementById('userName').innerText = userData.displayName;
            document.getElementById('userAvatar').src = userData.photoURL || 'https://i.pravatar.cc/150';
            document.getElementById('userID').innerText = userData.uid.substring(0, 8);
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯ ÙˆØ§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª
            document.getElementById('header-balance').innerText = userData.balance?.toLocaleString() || '0';
            document.getElementById('wallet-balance-big').innerText = userData.balance?.toLocaleString() || '0';
            document.getElementById('wealth-lv').innerText = `Ø«Ø±ÙˆØ© LV ${userData.wealthLv || 1}`;
            document.getElementById('magic-lv').innerText = `Ø³Ø­Ø± LV ${userData.magicLv || 1}`;
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø·Ø§Ø± Ø§Ù„Ù†Ø´Ø·
            const activeFrameImg = document.getElementById('activeFrame');
            if (userData.activeFrame) {
                const frame = storeItems.frames.find(f => f.id === userData.activeFrame);
                if (frame) {
                    activeFrameImg.src = frame.image;
                    activeFrameImg.style.display = 'block';
                }
            } else {
                activeFrameImg.style.display = 'none';
            }
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´Ø§Ø±Ø§Øª
            updateBadgesDisplay(userData.activeBadges || []);
        }

        function updateBadgesDisplay(activeBadges) {
            const badgeSlots = document.querySelectorAll('.badge-slot');
            badgeSlots.forEach((slot, index) => {
                slot.innerHTML = '';
                slot.classList.remove('has-badge');
                
                if (index < activeBadges.length) {
                    const badgeId = activeBadges[index];
                    const badge = storeItems.badges.find(b => b.id === badgeId);
                    if (badge) {
                        slot.innerHTML = badge.icon;
                        slot.classList.add('has-badge');
                    }
                }
            });
        }

        function renderRooms() {
            const container = document.getElementById('roomsContainer');
            container.innerHTML = "";
            for (let i = 1; i <= 7; i++) {
                container.innerHTML += `
                    <div class="bg-white p-3 rounded-2xl border text-center shadow-sm">
                        <img src="https://picsum.photos/seed/${i+10}/200" class="w-full h-24 object-cover rounded-xl mb-2">
                        <div class="font-bold text-[11px]">ØºØ±ÙØ© Ø£ÙÙ†Ø§Ù† ${i}</div>
                        <button class="w-full bg-gray-50 mt-2 py-1.5 rounded-lg text-[10px] font-bold">Ø¯Ø®ÙˆÙ„</button>
                    </div>
                `;
            }
        }

        function filterStore(type) {
            const container = document.getElementById('storeItems');
            container.innerHTML = "";
            const items = storeItems[type];
            
            items.forEach(item => {
                const isOwned = type === 'frames' 
                    ? (currentUserData?.purchasedFrames || []).includes(item.id)
                    : (currentUserData?.purchasedBadges || []).includes(item.id);
                
                const isEquipped = type === 'frames'
                    ? currentUserData?.activeFrame === item.id
                    : (currentUserData?.activeBadges || []).includes(item.id);
                
                container.innerHTML += `
                    <div class="store-item ${isOwned ? 'owned' : ''} ${isEquipped ? 'equipped' : ''}" 
                         onclick="${isOwned ? 'equipItem' : 'buyItem'}(${JSON.stringify(item)})">
                        <div class="text-3xl mb-2">${item.icon || `<img src="${item.image}" class="w-12 h-12 mx-auto">`}</div>
                        <div class="font-bold text-xs mb-1">${item.name}</div>
                        <div class="text-[10px] text-gray-500 mb-2">${item.price.toLocaleString()} ğŸ’°</div>
                        <button class="w-full ${isOwned ? 'bg-green-500' : 'bg-orange-500'} text-white py-2 rounded-xl text-[10px] font-bold">
                            ${isOwned ? (isEquipped ? 'ğŸ’ Ù…ÙÙØ¹Ù‘Ù„' : 'ØªÙØ¹ÙŠÙ„') : 'Ø´Ø±Ø§Ø¡'}
                        </button>
                    </div>
                `;
            });
        }

        function equipItem(item) {
            const user = auth.currentUser;
            if (!user || !currentUserData) return;
            
            import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js")
                .then(({ doc, updateDoc, getFirestore }) => {
                    const db = getFirestore();
                    const userRef = doc(db, "users", user.uid);
                    
                    let updates = {};
                    if (item.type === 'frame') {
                        updates.activeFrame = item.id;
                    } else if (item.type === 'badge') {
                        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø´Ø§Ø±Ø© Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø©ØŒ Ø£Ùˆ Ø¥Ø²Ø§Ù„ØªÙ‡Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
                        let activeBadges = [...(currentUserData.activeBadges || [])];
                        const index = activeBadges.indexOf(item.id);
                        
                        if (index > -1) {
                            activeBadges.splice(index, 1); // Ø¥Ø²Ø§Ù„Ø©
                        } else {
                            if (activeBadges.length < 4) {
                                activeBadges.push(item.id); // Ø¥Ø¶Ø§ÙØ©
                            } else {
                                showToast("Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ø£ÙƒØ«Ø± Ù…Ù† 4 Ø´Ø§Ø±Ø§Øª");
                                return;
                            }
                        }
                        updates.activeBadges = activeBadges;
                    }
                    
                    return updateDoc(userRef, updates);
                })
                .then(() => {
                    loadUserData(user.uid);
                    showToast(`âœ… ØªÙ… ${item.type === 'frame' ? 'ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø·Ø§Ø±' : 'ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´Ø§Ø±Ø§Øª'}`);
                })
                .catch(error => {
                    console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªÙØ¹ÙŠÙ„:", error);
                    showToast("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªÙØ¹ÙŠÙ„");
                });
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
            document.getElementById('overlay').classList.toggle('active');
        }

        function toggleSearch() {
            document.getElementById('searchContainer').classList.toggle('active');
            if (document.getElementById('searchContainer').classList.contains('active')) {
                document.getElementById('searchInput').focus();
            }
        }

        function switchView(v) {
            document.querySelectorAll('.view-screen').forEach(s => s.classList.remove('active'));
            document.getElementById(`view-${v}`).classList.add('active');
            
            const titles = {
                'rooms': 'Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©',
                'wallet': 'Ø§Ù„Ù…Ø­ÙØ¸Ø©',
                'store': 'Ø§Ù„Ù…ØªØ¬Ø±'
            };
            document.getElementById('view-title').innerText = titles[v] || v;
            
            if (document.getElementById('sidebar').classList.contains('open')) toggleSidebar();
            if (document.getElementById('searchContainer').classList.contains('active')) toggleSearch();
        }

        function showToast(message) {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = "bg-gray-900 text-white px-6 py-3 rounded-2xl text-xs font-bold mb-2 shadow-2xl animate-bounce";
            toast.innerText = message;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        window.onload = () => lucide.createIcons();
    </script>
</body>
</html>
