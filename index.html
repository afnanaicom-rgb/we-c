<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Afnan AI - Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: 'Noto Sans Arabic', sans-serif; }
        body, html { height: 100%; margin: 0; background-color: #f8f9fa; color: #1a1a1a; overflow-x: hidden; }
        
        .view-screen { position: absolute; inset: 0; width: 100%; height: 100%; background: #f8f9fa; display: none; flex-direction: column; z-index: 10; padding-top: 120px; overflow-y: auto; }
        .view-screen.active { display: flex; }

        .app-header { position: fixed; top: 0; right: 0; left: 0; height: 110px; background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(20px); border-bottom: 1px solid #eee; display: flex; flex-direction: column; z-index: 1000; }
        .header-top { height: 60px; display: flex; align-items: center; justify-content: space-between; padding: 0 1rem; width: 100%; }
        .header-tabs { height: 50px; display: flex; align-items: center; justify-content: center; gap: 20px; border-top: 1px solid #f0f0f0; }
        .tab-link { font-weight: bold; font-size: 14px; color: #666; cursor: pointer; padding: 5px 15px; border-radius: 20px; }
        .tab-link.active { color: #f59e0b; background: #fff7ed; }

        .profile-container { position: relative; width: 100px; height: 100px; margin: 0 auto; }
        .avatar-img { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; position: absolute; top: 10px; left: 10px; z-index: 1; }
        .user-frame { position: absolute; inset: 0; z-index: 2; width: 100%; height: 100%; pointer-events: none; }
        
        .level-badge { font-size: 10px; font-weight: 800; padding: 2px 8px; border-radius: 10px; color: white; margin: 2px; }
        .wealth-lv { background: linear-gradient(to left, #f59e0b, #d97706); }
        .magic-lv { background: linear-gradient(to left, #8b5cf6, #6d28d9); }
        .recharge-lv { background: linear-gradient(to left, #10b981, #059669); }

        .badges-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; padding: 10px; width: 100%; max-width: 250px; margin: 0 auto; }
        .badge-slot { width: 35px; height: 35px; background: #f3f4f6; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 18px; border: 1px dashed #ccc; }

        .banner-container { margin: 0 15px 20px; border-radius: 25px; overflow: hidden; height: 180px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
        .banner-image { width: 100%; height: 100%; object-fit: cover; }
        
        .room-card { background: white; border-radius: 20px; padding: 15px; border: 1px solid #eee; display: flex; align-items: center; gap: 15px; margin-bottom: 12px; }
        .room-img { width: 60px; height: 60px; border-radius: 15px; object-fit: cover; }

        .sidebar { position: fixed; top: 0; right: -300px; width: 300px; height: 100%; background: white; z-index: 4000; transition: 0.4s; border-left: 1px solid #eee; }
        .sidebar.open { right: 0; }
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.3); z-index: 2500; display: none; backdrop-filter: blur(4px); }
        .overlay.active { display: block; }

        .floating-room { position: fixed; bottom: 80px; left: 20px; width: 60px; height: 60px; background: #f59e0b; border-radius: 50%; z-index: 9000; display: none; align-items: center; justify-content: center; box-shadow: 0 5px 15px rgba(245,158,11,0.4); animation: pulse 2s infinite; cursor: pointer; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }

        /* Login Styles */
        .login-btn { width: 100%; max-width: 280px; display: flex; align-items: center; justify-content: center; gap: 10px; padding: 14px; border-radius: 18px; font-weight: bold; margin-bottom: 12px; transition: 0.2s; }
        .btn-google { background: white; border: 1px solid #eee; color: #333; }
        .btn-x { background: #000; color: white; }
    </style>
</head>
<body>

    <div id="toastContainer" class="fixed bottom-5 left-1/2 -translate-x-1/2 z-[11000]"></div>

    <!-- ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
    <div id="loginPage" class="fixed inset-0 bg-white z-[10000] flex flex-col items-center justify-center p-8">
        <img src="https://files.manuscdn.com/user_upload_by_module/session_file/310519663174655187/mcieZCLEOIrmCjBq.png" class="w-28 mb-4">
        <h1 class="text-2xl font-bold text-gray-800 mb-8">Welcome to Afnan AI</h1>
        
        <div id="userLoginSection" class="w-full flex flex-col items-center">
            <button onclick="loginWithGoogle()" class="login-btn btn-google shadow-sm">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-5">
                ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¹Ø¨Ø± Ø¬ÙˆØ¬Ù„
            </button>
            <button onclick="loginWithX()" class="login-btn btn-x">
                <svg class="w-5 h-5 fill-current" viewBox="0 0 24 24"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
                ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¹Ø¨Ø± Ù…Ù†ØµØ© X
            </button>
            
            <div class="mt-8 text-center">
                <p class="text-[11px] text-gray-400">Ø¨Ø§Ù„Ø§Ø³ØªÙ…Ø±Ø§Ø±ØŒ Ø£Ù†Øª ØªÙˆØ§ÙÙ‚ Ø¹Ù„Ù‰</p>
                <div class="flex gap-2 justify-center mt-1">
                    <a href="#" class="text-[11px] text-blue-500 underline">Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø®ØµÙˆØµÙŠØ©</a>
                    <span class="text-[11px] text-gray-400">Ùˆ</span>
                    <a href="#" class="text-[11px] text-blue-500 underline">Ø§ØªÙØ§Ù‚ÙŠØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</a>
                </div>
            </div>
        </div>
        
        <div id="loginLoading" class="mt-4 hidden flex items-center gap-2">
            <div class="w-5 h-5 border-2 border-orange-500 border-t-transparent rounded-full animate-spin"></div>
            <span class="text-gray-500 text-sm">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
        </div>
    </div>

    <!-- Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
    <div id="main-app" style="display: none;">
        <header class="app-header">
            <div class="header-top">
                <button onclick="toggleSidebar()" class="p-2 bg-gray-50 rounded-lg"><i data-lucide="menu"></i></button>
                <div class="font-bold" id="view-title">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
                <div class="flex items-center gap-2">
                    <div class="flex items-center gap-2 bg-orange-50 px-3 py-1 rounded-full cursor-pointer" onclick="switchView('wallet')">
                        <span id="header-balance" class="text-xs font-bold text-orange-600">0</span>
                        <span>ğŸ’°</span>
                    </div>
                </div>
            </div>
            <div class="header-tabs">
                <div id="tab-public" class="tab-link active" onclick="switchTab('public')">Ø¹Ø§Ù…Ø©</div>
                <div id="tab-private" class="tab-link" onclick="switchTab('private')">Ø®Ø§Øµ Ø¨ÙŠ</div>
            </div>
        </header>

        <!-- Ø§Ù„Ø³Ø§ÙŠØ¯Ø¨Ø§Ø± -->
        <div id="sidebar" class="sidebar overflow-y-auto">
            <div class="p-6 text-center border-b">
                <div class="profile-container">
                    <img id="userAvatar" src="https://i.pravatar.cc/150" class="avatar-img">
                    <img id="activeFrame" src="" class="user-frame" style="display: none;">
                </div>
                <div id="userName" class="font-bold mt-2 text-gray-800">ØªØ­Ù…ÙŠÙ„...</div>
                <div id="userIDBadge" class="relative inline-flex items-center px-4 py-1 bg-gray-100 rounded-full text-[12px] font-bold mt-2">
                    <span id="userID">00000000</span>
                    <img id="idImage" class="absolute inset-0 w-full h-full object-cover rounded-full opacity-0" src="">
                </div>
                <div class="flex flex-wrap justify-center gap-1 mt-3">
                    <span id="wealth-lv" class="level-badge wealth-lv">Ø«Ø±ÙˆØ© LV 1</span>
                    <span id="magic-lv" class="level-badge magic-lv">Ø³Ø­Ø± LV 1</span>
                </div>
                <div id="userBadges" class="badges-grid mt-4"></div>
            </div>
            <nav class="p-4">
                <button onclick="switchView('home')" class="w-full flex items-center gap-3 p-4 hover:bg-gray-50 rounded-2xl transition mb-1">
                    <i data-lucide="home" class="w-5 h-5 text-gray-500"></i>
                    <span class="font-bold text-sm">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
                </button>
                <button onclick="switchView('wallet')" class="w-full flex items-center gap-3 p-4 hover:bg-gray-50 rounded-2xl transition mb-1">
                    <i data-lucide="wallet" class="w-5 h-5 text-gray-500"></i>
                    <span class="font-bold text-sm">Ø§Ù„Ù…Ø­ÙØ¸Ø©</span>
                </button>
                <button onclick="switchView('store')" class="w-full flex items-center gap-3 p-4 hover:bg-gray-50 rounded-2xl transition mb-1">
                    <i data-lucide="shopping-bag" class="w-5 h-5 text-gray-500"></i>
                    <span class="font-bold text-sm">Ø§Ù„Ù…ØªØ¬Ø±</span>
                </button>
                <a id="adminPanelBtn" href="admin.html" class="hidden w-full flex items-center gap-3 p-4 hover:bg-gray-50 rounded-2xl transition mb-1 text-orange-600">
                    <i data-lucide="shield-check" class="w-5 h-5"></i>
                    <span class="font-bold text-sm">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</span>
                </a>
                <button onclick="logout()" class="w-full flex items-center gap-3 p-4 hover:bg-red-50 rounded-2xl transition mt-4 text-red-500">
                    <i data-lucide="log-out" class="w-5 h-5"></i>
                    <span class="font-bold text-sm">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</span>
                </button>
            </nav>
        </div>

        <!-- Ø§Ù„Ø´Ø§Ø´Ø§Øª -->
        <div id="view-home" class="view-screen active">
            <div id="bannerContainer" class="banner-container"></div>
            
            <!-- Ù‚Ø³Ù… Ø§Ù„ØºØ±Ù Ø§Ù„Ø¹Ø§Ù…Ø© -->
            <div id="public-rooms" class="px-4">
                <h3 class="font-bold text-gray-800 mb-4">Ø§Ù„ØºØ±Ù Ø§Ù„Ø¹Ø§Ù…Ø©</h3>
                <div id="roomsList" class="grid grid-cols-1 gap-3">
                    <!-- Ø³ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ 5 ØºØ±Ù Ù‡Ù†Ø§ -->
                </div>
            </div>

            <!-- Ù‚Ø³Ù… Ø§Ù„ØºØ±Ù Ø§Ù„Ø®Ø§ØµØ© -->
            <div id="private-rooms" class="px-4 hidden">
                <div class="bg-white p-6 rounded-[30px] border border-dashed border-orange-300 text-center mb-6">
                    <h3 class="font-bold text-orange-600 mb-2">Ø£Ù†Ø´Ø¦ ØºØ±ÙØªÙƒ Ø§Ù„Ø®Ø§ØµØ©</h3>
                    <p class="text-xs text-gray-500 mb-4">Ø®ØµØµ ØºØ±ÙØªÙƒ ÙˆØ§Ø¯Ø¹Ù Ø£ØµØ¯Ù‚Ø§Ø¡Ùƒ</p>
                    <button onclick="openCreateRoom()" class="bg-orange-500 text-white px-8 py-3 rounded-2xl font-bold text-sm">Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ©</button>
                </div>
                <div id="myRoomsList"></div>
            </div>
        </div>

        <!-- Ù…ÙˆØ¯Ø§Ù„ Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ© -->
        <div id="createRoomModal" class="fixed inset-0 bg-black/50 z-[5000] hidden items-center justify-center p-6">
            <div class="bg-white w-full max-w-md rounded-[30px] p-6">
                <h3 class="font-bold text-lg mb-4">Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ© Ø¬Ø¯ÙŠØ¯Ø©</h3>
                <div class="space-y-4">
                    <div onclick="document.getElementById('roomImageInput').click()" class="w-24 h-24 bg-gray-100 rounded-2xl mx-auto flex items-center justify-center cursor-pointer overflow-hidden border-2 border-dashed border-gray-300">
                        <img id="roomPreview" class="hidden w-full h-full object-cover">
                        <i data-lucide="image" id="roomPlaceholderIcon"></i>
                    </div>
                    <input type="file" id="roomImageInput" class="hidden" accept="image/*" onchange="previewRoomImage(this)">
                    <input type="text" id="roomName" class="w-full p-4 bg-gray-50 rounded-2xl border-none text-sm" placeholder="Ø§Ø³Ù… Ø§Ù„ØºØ±ÙØ©">
                    <textarea id="roomDesc" class="w-full p-4 bg-gray-50 rounded-2xl border-none text-sm h-24" placeholder="ÙˆØµÙ Ø§Ù„ØºØ±ÙØ©"></textarea>
                    <div class="flex gap-3">
                        <button onclick="createRoom()" class="flex-1 bg-orange-500 text-white py-4 rounded-2xl font-bold">Ø¥Ù†Ø´Ø§Ø¡</button>
                        <button onclick="closeCreateRoom()" class="flex-1 bg-gray-100 text-gray-500 py-4 rounded-2xl font-bold">Ø¥Ù„ØºØ§Ø¡</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-wallet" class="view-screen">
            <!-- Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ø­ÙØ¸Ø© -->
        </div>

        <div id="view-store" class="view-screen">
            <!-- Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…ØªØ¬Ø± -->
        </div>

        <div id="overlay" class="overlay" onclick="toggleSidebar()"></div>
        
        <!-- Ø§Ù„ØºØ±ÙØ© Ø§Ù„Ù…ØµØºØ±Ø© -->
        <div id="floatingRoom" class="floating-room" onclick="reopenRoom()">
            <i data-lucide="mic" class="text-white"></i>
        </div>
    </div>

    <!-- Firebase & Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, signInWithPopup, GoogleAuthProvider, TwitterAuthProvider } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, query, getDocs, serverTimestamp, orderBy, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getDatabase, ref, onValue, set, push } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBnmqWRY6lV54meFvO89QeXwtd28w81FcY",
            authDomain: "rtx3090-28439.firebaseapp.com",
            projectId: "rtx3090-28439",
            storageBucket: "rtx3090-28439.firebasestorage.app",
            messagingSenderId: "178612030690",
            appId: "1:178612030690:web:883189ced2ed3a78e3e2bb",
            databaseURL: "https://rtx3090-28439-default-rtdb.firebaseio.com"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const rtdb = getDatabase(app);

        window.currentUserData = null;
        const ADMIN_EMAIL = "html55551@gmail.com";

        // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
        window.loginWithGoogle = async () => {
            const provider = new GoogleAuthProvider();
            await signInWithPopup(auth, provider);
        };

        window.loginWithX = async () => {
            const provider = new TwitterAuthProvider();
            await signInWithPopup(auth, provider);
        };

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                await initUser(user);
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('main-app').style.display = 'block';
                loadInitialData();
            } else {
                document.getElementById('loginPage').style.display = 'flex';
                document.getElementById('main-app').style.display = 'none';
            }
        });

        async function initUser(user) {
            const userRef = doc(db, "users", user.uid);
            const snap = await getDoc(userRef);
            if (!snap.exists()) {
                await setDoc(userRef, {
                    uid: user.uid,
                    displayName: user.displayName,
                    email: user.email,
                    photoURL: user.photoURL,
                    customId: Math.floor(10000000 + Math.random() * 90000000).toString(),
                    balance: 1000,
                    wealthLv: 1, magicLv: 1,
                    activeBadges: [],
                    createdAt: serverTimestamp()
                });
            }
            window.currentUserData = (await getDoc(userRef)).data();
            updateUI();
        }

        function updateUI() {
            const u = window.currentUserData;
            document.getElementById('userName').innerText = u.displayName;
            document.getElementById('userAvatar').src = u.photoURL;
            document.getElementById('userID').innerText = u.customId;
            document.getElementById('header-balance').innerText = u.balance.toLocaleString();
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø±ØµÙŠØ¯ (Ø³ÙŠØªÙ… Ø¬Ù„Ø¨Ù‡Ø§ Ù…Ù† Firebase Ù„Ø§Ø­Ù‚Ø§Ù‹)
            updateLevels(u);
            
            if (u.email === ADMIN_EMAIL) document.getElementById('adminPanelBtn').classList.remove('hidden');
            lucide.createIcons();
        }

        async function updateLevels(u) {
            // Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª Ù…Ù† Firestore
            const levelsSnap = await getDocs(query(collection(db, "levels"), orderBy("levelNumber")));
            let currentWealth = 1;
            levelsSnap.forEach(doc => {
                const l = doc.data();
                if (l.type === 'wealth' && u.balance >= l.required) currentWealth = l.levelNumber;
            });
            document.getElementById('wealth-lv').innerText = `Ø«Ø±ÙˆØ© LV ${currentWealth}`;
        }

        async function loadInitialData() {
            loadBanners();
            loadPublicRooms();
            checkMinimizedRoom();
        }

        function checkMinimizedRoom() {
            const roomId = localStorage.getItem('minimizedRoom');
            if (roomId) {
                document.getElementById('floatingRoom').style.display = 'flex';
            }
        }

        window.reopenRoom = () => {
            const roomId = localStorage.getItem('minimizedRoom');
            if (roomId) window.location.href = `room.html?id=${roomId}`;
        };

        async function loadBanners() {
            const snap = await getDocs(collection(db, "banners"));
            const container = document.getElementById('bannerContainer');
            container.innerHTML = '';
            snap.forEach(doc => {
                const b = doc.data();
                container.innerHTML = `<img src="${b.imageUrl}" class="banner-image">`;
            });
        }

        function loadPublicRooms() {
            const container = document.getElementById('roomsList');
            container.innerHTML = '';
            // ØºØ±Ù ÙˆÙ‡Ù…ÙŠØ© Ù„Ù„Ø¨Ø¯Ø¡
            for(let i=1; i<=5; i++) {
                container.innerHTML += `
                    <div class="room-card" onclick="enterRoom('room_${i}')">
                        <img src="https://picsum.photos/200?random=${i}" class="room-img">
                        <div class="flex-1">
                            <div class="font-bold text-sm">ØºØ±ÙØ© Ø§Ù„ÙˆÙ†Ø§Ø³Ø© ${i}</div>
                            <div class="text-[10px] text-gray-400">Ø§Ø³ØªÙ…ØªØ¹ Ø¨Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„ØµÙˆØªÙŠØ©</div>
                        </div>
                        <div class="flex items-center gap-1 text-orange-500 font-bold text-xs">
                            <i data-lucide="users" class="w-3 h-3"></i> 24
                        </div>
                    </div>
                `;
            }
            lucide.createIcons();
        }

        window.switchTab = (tab) => {
            document.querySelectorAll('.tab-link').forEach(l => l.classList.remove('active'));
            document.getElementById('tab-' + tab).classList.add('active');
            if (tab === 'public') {
                document.getElementById('public-rooms').classList.remove('hidden');
                document.getElementById('private-rooms').classList.add('hidden');
            } else {
                document.getElementById('public-rooms').classList.add('hidden');
                document.getElementById('private-rooms').classList.remove('hidden');
            }
        };

        window.enterRoom = (roomId) => {
            window.location.href = `room.html?id=${roomId}`;
        };

        window.toggleSidebar = () => {
            document.getElementById('sidebar').classList.toggle('open');
            document.getElementById('overlay').classList.toggle('active');
        };

        window.logout = async () => {
            await signOut(auth);
            location.reload();
        };

        lucide.createIcons();
    </script>
</body>
</html>
