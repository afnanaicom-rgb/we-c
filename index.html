<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Afnan AI - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø·ÙˆØ±Ø©</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: 'Noto Sans Arabic', sans-serif; }
        body, html { height: 100%; margin: 0; background-color: #f8f9fa; color: #1a1a1a; overflow-x: hidden; }

        .view-screen { position: absolute; inset: 0; width: 100%; height: 100%; background: #f8f9fa; display: none; flex-direction: column; z-index: 10; padding-top: 120px; overflow-y: auto; padding-bottom: 80px; }
        .view-screen.active { display: flex; }

        .app-header { position: fixed; top: 0; right: 0; left: 0; height: 110px; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); border-bottom: 1px solid #eee; display: flex; flex-direction: column; z-index: 1000; }
        .header-top { height: 60px; display: flex; align-items: center; justify-content: space-between; padding: 0 1rem; width: 100%; }
        .header-tabs { height: 50px; display: flex; align-items: center; justify-content: center; gap: 20px; border-top: 1px solid #f0f0f0; }
        .tab-link { font-weight: bold; font-size: 14px; color: #9ca3af; cursor: pointer; padding: 5px 20px; border-radius: 20px; transition: 0.3s; }
        .tab-link.active { color: #f59e0b; background: #fff7ed; }

        /* --- Profile Styles (Adjusted) --- */
        .profile-container { position: relative; width: 100px; height: 100px; margin: 0 auto; display: flex; align-items: center; justify-content: center; }
        .avatar-img { width: 55px; height: 55px; border-radius: 50%; object-fit: cover; z-index: 1; border: 2px solid white; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .user-frame { position: absolute; width: 120%; height: 120%; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 2; pointer-events: none; object-fit: contain; }

        /* --- Integrated Level & Badges Design --- */
        .level-container { display: flex; justify-content: center; gap: 10px; margin-top: 15px; flex-wrap: wrap; }
        .level-badge-wrapper { position: relative; width: 60px; height: 35px; display: flex; align-items: center; }
        .level-img { width: 100%; height: 100%; object-fit: contain; }
        .level-number { position: absolute; right: 8px; top: 50%; transform: translateY(-50%); color: white; font-size: 10px; font-weight: 900; z-index: 5; pointer-events: none; }

        .glowing-id { font-family: 'Courier New', monospace; font-weight: 900; animation: glow-red-blue 3s infinite alternate; }
        @keyframes glow-red-blue {
            0% { color: #ef4444; text-shadow: 0 0 5px rgba(239, 68, 68, 0.5); }
            100% { color: #3b82f6; text-shadow: 0 0 5px rgba(59, 130, 246, 0.5); }
        }

        /* Store & Items */
        .store-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; padding: 15px; }
        .store-card { background: white; border-radius: 18px; padding: 12px; text-align: center; border: 1px solid #f0f0f0; display: flex; flex-direction: column; align-items: center; position: relative; height: 180px; }
        .item-label { position: absolute; top: 5px; left: 8px; font-size: 9px; font-weight: 800; color: #9ca3af; text-transform: uppercase; }

        .action-btn { width: 100%; padding: 8px 0; border-radius: 12px; font-size: 11px; font-weight: bold; margin-top: auto; cursor: pointer; transition: 0.2s; }
        .btn-buy { background: #f59e0b; color: white; }
        .btn-equip { background: #3b82f6; color: white; }
        .btn-unequip { background: #ef4444; color: white; }

        .sidebar { position: fixed; top: 0; right: -300px; width: 300px; height: 100%; background: white; z-index: 4000; transition: 0.3s; border-left: 1px solid #eee; display: flex; flex-direction: column; }
        .sidebar.open { right: 0; }
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 2500; display: none; backdrop-filter: blur(2px); }
        .overlay.active { display: block; }

        .nav-icon { width: 22px; height: 22px; object-fit: contain; }

        /* --- Home Page --- */
        .search-bar { position: fixed; top: 110px; right: 1rem; left: 1rem; height: 45px; background: white; border-radius: 25px; display: flex; align-items: center; padding: 0 15px; border: 1px solid #eee; z-index: 999; }
        .search-bar input { flex: 1; border: none; outline: none; background: transparent; font-size: 14px; }
    </style>
</head>
<body>

    <div id="toastContainer" class="fixed bottom-10 left-1/2 -translate-x-1/2 z-[11000]"></div>

    <!-- Login Page -->
    <div id="loginPage" class="fixed inset-0 bg-white z-[10000] flex flex-col items-center justify-center p-8">
        <img src="https://files.manuscdn.com/user_upload_by_module/session_file/310519663174655187/mcieZCLEOIrmCjBq.png" class="w-24 mb-6">
        <h1 class="text-3xl font-black text-gray-800 mb-10">Afnan AI</h1>
        <button onclick="loginWithGoogle()" class="w-full max-w-xs flex items-center justify-center gap-3 p-4 border border-gray-200 rounded-2xl font-bold hover:bg-gray-50 transition">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-5">
            ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¹Ø¨Ø± Ø¬ÙˆØ¬Ù„
        </button>
    </div>

    <div id="main-app" style="display: none;">
        <header class="app-header">
            <div class="header-top">
                <button onclick="toggleSidebar()" class="w-10 h-10 flex items-center justify-center bg-gray-50 rounded-xl"><i data-lucide="menu"></i></button>
                <div class="font-bold text-lg" id="view-title">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
                <div class="flex items-center gap-2">
                    <button class="w-10 h-10 flex items-center justify-center bg-gray-50 rounded-xl"><i data-lucide="search" class="w-5"></i></button>
                </div>
            </div>
            <div class="header-tabs" id="main-tabs">
                <div class="tab-link active" onclick="switchTab('public')">ØºØ±Ù Ø¹Ø§Ù…Ø©</div>
                <div class="tab-link" onclick="switchTab('private')">Ø®Ø§Øµ Ø¨ÙŠ</div>
            </div>
        </header>

        <!-- Search Bar -->
        <div class="search-bar">
            <i data-lucide="search" class="w-4 text-gray-400"></i>
            <input type="text" placeholder="Ø¨Ø­Ø«..." class="mx-2">
        </div>

        <!-- Sidebar -->
        <div id="sidebar" class="sidebar">
            <div class="p-6 text-center border-b border-gray-50">
                <div class="profile-container mb-3">
                    <img id="userAvatar" src="" class="avatar-img">
                    <img id="activeFrame" src="" class="user-frame" style="display: none;">
                </div>
                <div class="flex items-center justify-center gap-2 mb-1">
                    <div id="userName" class="font-bold text-gray-800">...</div>
                    <button onclick="openEditProfile()" class="text-gray-400"><i data-lucide="edit-3" class="w-3"></i></button>
                </div>
                <div class="inline-flex items-center gap-2 px-3 py-1 bg-gray-50 rounded-lg text-[11px] mb-4">
                    <span class="glowing-id" id="userID">00000000</span>
                    <button onclick="copyID()"><i data-lucide="copy" class="w-3"></i></button>
                </div>

                <div class="level-container" id="levels-wrapper">
                    <!-- Levels and badges injected here -->
                </div>
            </div>

            <nav class="p-4 space-y-1">
                <button onclick="switchView('home')" class="w-full flex items-center gap-4 p-3 hover:bg-orange-50 rounded-xl transition">
                    <i data-lucide="home" class="w-5 text-gray-400"></i><span class="font-bold text-sm text-gray-600">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
                </button>
                <button onclick="switchView('wallet')" class="w-full flex items-center gap-4 p-3 hover:bg-orange-50 rounded-xl transition">
                    <img src="https://i.postimg.cc/s1dKBjg5/ic_me_wallet_1.webp" class="nav-icon">
                    <span class="font-bold text-sm text-gray-600">Ø§Ù„Ù…Ø­ÙØ¸Ø©</span>
                </button>
                <button onclick="switchView('store')" class="w-full flex items-center gap-4 p-3 hover:bg-orange-50 rounded-xl transition">
                    <img src="https://i.postimg.cc/jC0vWxSN/ic_main_me_store.webp" class="nav-icon">
                    <span class="font-bold text-sm text-gray-600">Ø§Ù„Ù…ØªØ¬Ø±</span>
                </button>
                <button onclick="switchView('bag')" class="w-full flex items-center gap-4 p-3 hover:bg-orange-50 rounded-xl transition">
                    <img src="https://i.postimg.cc/5jdpH42L/ic_lucky_bag.png" class="nav-icon">
                    <span class="font-bold text-sm text-gray-600">Ø­Ù‚ÙŠØ¨ØªÙŠ</span>
                </button>
            </nav>
            <div class="mt-auto p-4 border-t border-gray-50">
                <button onclick="logout()" class="w-full p-3 bg-red-50 text-red-500 rounded-xl font-bold text-sm">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
            </div>
        </div>

        <!-- Views -->
        <div id="view-home" class="view-screen active">
            <div id="bannerContainer" class="mx-4 mb-6 rounded-2xl overflow-hidden shadow-sm h-[160px] bg-gray-200"></div>
            <div id="roomsList" class="px-4 pb-20 space-y-3"></div>
        </div>

        <div id="view-wallet" class="view-screen">
            <div class="mx-5 p-8 bg-slate-900 rounded-3xl text-white mb-6">
                <div class="text-xs text-gray-400 mb-1">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…ØªÙˆÙØ±</div>
                <div class="text-4xl font-black"><span id="wallet-balance-big">0</span> ğŸ’°</div>
            </div>
            <div class="px-5 space-y-3">
                <h3 class="font-bold">Ø´Ø­Ù† Ø§Ù„Ø±ØµÙŠØ¯</h3>
                <div class="p-4 bg-white rounded-2xl flex items-center justify-between border border-gray-100 shadow-sm">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-yellow-100 rounded-full flex items-center justify-center">ğŸ’</div>
                        <div><div class="font-bold text-sm">27,000 Ø¹Ù…Ù„Ø©</div><div class="text-[10px] text-gray-400">Ø¨Ø§Ù‚Ø© Ø§Ù„Ù…Ø¨ØªØ¯Ø¦ÙŠÙ†</div></div>
                    </div>
                    <button onclick="recharge(27000, 1)" class="bg-blue-600 text-white px-4 py-2 rounded-xl text-xs font-bold">1.00$</button>
                </div>
            </div>
        </div>

        <div id="view-store" class="view-screen">
            <div class="flex gap-2 p-3 bg-white border-b sticky top-0 z-10">
                <button onclick="filterStore('frames')" id="fBtn" class="flex-1 py-2 rounded-xl text-xs font-bold bg-gray-100">Ø¥Ø·Ø§Ø±Ø§Øª</button>
                <button onclick="filterStore('badges')" id="bBtn" class="flex-1 py-2 rounded-xl text-xs font-bold">Ø´Ø§Ø±Ø§Øª</button>
            </div>
            <div id="storeItems" class="store-grid"></div>
        </div>

        <div id="view-bag" class="view-screen">
            <div id="bagItems" class="store-grid"></div>
        </div>

        <div id="overlay" class="overlay" onclick="toggleSidebar()"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, signInWithPopup, GoogleAuthProvider } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, getDocs, onSnapshot, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBnmqWRY6lV54meFvO89QeXwtd28w81FcY",
            authDomain: "rtx3090-28439.firebaseapp.com",
            projectId: "rtx3090-28439",
            storageBucket: "rtx3090-28439.firebasestorage.app",
            messagingSenderId: "178612030690",
            appId: "1:178612030690:web:883189ced2ed3a78e3e2bb"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let uData = null;
        let storeData = { frames: [], badges: [] };

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                onSnapshot(doc(db, "users", user.uid), (snap) => {
                    if (snap.exists()) {
                        uData = snap.data();
                        checkExpiredItems();
                        updateUI();
                    }
                });
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('main-app').style.display = 'block';
                loadStore();
                loadBanners();
            } else {
                document.getElementById('loginPage').style.display = 'flex';
                document.getElementById('main-app').style.display = 'none';
            }
        });

        async function checkExpiredItems() {
            if (!uData.purchasedFrames) return;
            const now = Date.now();
            let changed = false;
            const newFrames = uData.purchasedFrames.filter(item => {
                if (now > item.expiry) { changed = true; return false; }
                return true;
            });
            if (changed) {
                const update = { purchasedFrames: newFrames };
                if (uData.activeFrame && !newFrames.find(f => f.id === uData.activeFrame)) {
                    update.activeFrame = null;
                }
                await updateDoc(doc(db, "users", auth.currentUser.uid), update);
            }
        }

        function updateUI() {
            document.getElementById('userName').innerText = uData.displayName;
            document.getElementById('userAvatar').src = uData.photoURL;
            document.getElementById('userID').innerText = uData.customId;
            document.getElementById('header-balance').innerText = uData.balance.toLocaleString();
            document.getElementById('wallet-balance-big').innerText = uData.balance.toLocaleString();

            const frameImg = document.getElementById('activeFrame');
            if (uData.activeFrame) {
                const f = storeData.frames.find(x => x.id === uData.activeFrame);
                if (f) { frameImg.src = f.image; frameImg.style.display = 'block'; }
            } else frameImg.style.display = 'none';

            const lvWrapper = document.getElementById('levels-wrapper');
            lvWrapper.innerHTML = '';

            if (uData.wealthLevel) renderLv(uData.wealthLevel, 'wealth', 'https://i.postimg.cc/MX2tc6py/ic_main_me_level.webp');
            if (uData.magicLevel) renderLv(uData.magicLevel, 'magic', 'https://i.postimg.cc/MX2tc6py/ic_main_me_level.webp');

            lucide.createIcons();
        }

        function renderLv(val, type, icon) {
            const wrapper = document.getElementById('levels-wrapper');
            wrapper.innerHTML += `
                <div class="level-badge-wrapper">
                    <img src="${icon}" class="level-img">
                    <span class="level-number">${val}</span>
                </div>
            `;
        }

        async function loadStore() {
            const f = await getDocs(collection(db, "frames"));
            storeData.frames = f.docs.map(d => ({id: d.id, ...d.data()}));
            const b = await getDocs(collection(db, "badges"));
            storeData.badges = b.docs.map(d => ({id: d.id, ...d.data()}));
            filterStore('frames');
        }

        window.filterStore = (type) => {
            const container = document.getElementById('storeItems');
            container.innerHTML = '';
            document.getElementById('fBtn').classList.toggle('bg-gray-100', type==='frames');
            document.getElementById('bBtn').classList.toggle('bg-gray-100', type==='badges');

            storeData[type].forEach(item => {
                container.innerHTML += `
                    <div class="store-card">
                        <span class="item-label">${type === 'frames' ? 'Ø¥Ø·Ø§Ø±' : 'Ø´Ø§Ø±Ø©'}</span>
                        <div class="h-20 flex items-center justify-center mt-4">
                            ${type === 'frames' ? `<img src="${item.image}" class="w-16">` : `<span class="text-4xl">${item.icon}</span>`}
                        </div>
                        <div class="text-[11px] font-bold mt-2">${item.name}</div>
                        <button onclick="buyItem('${type}', '${item.id}', ${item.price})" class="action-btn btn-buy">Ø´Ø±Ø§Ø¡ ${item.price}ğŸ’°</button>
                    </div>
                `;
            });
        };

        window.buyItem = async (type, id, price) => {
            if (uData.balance < price) return showToast("Ø±ØµÙŠØ¯Ùƒ ØºÙŠØ± ÙƒØ§ÙÙ", "error");
            const expiry = Date.now() + (24 * 60 * 60 * 1000);
            const userRef = doc(db, "users", auth.currentUser.uid);

            const listKey = type === 'frames' ? 'purchasedFrames' : 'purchasedBadges';
            const currentList = uData[listKey] || [];

            const newList = currentList.filter(x => x.id !== id);
            newList.push({ id, expiry });

            await updateDoc(userRef, {
                balance: increment(-price),
                [listKey]: newList
            });
            showToast("ØªÙ… Ø§Ù„Ø´Ø±Ø§Ø¡ Ù„Ù…Ø¯Ø© ÙŠÙˆÙ… ÙˆØ§Ø­Ø¯");
        };

        window.switchView = (v) => {
            document.querySelectorAll('.view-screen').forEach(s => s.classList.remove('active'));
            document.getElementById('view-' + v).classList.add('active');
            document.getElementById('view-title').innerText = v === 'home' ? 'Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©' : (v === 'bag' ? 'Ø­Ù‚ÙŠØ¨ØªÙŠ' : (v==='store' ? 'Ø§Ù„Ù…ØªØ¬Ø±' : 'Ø§Ù„Ù…Ø­ÙØ¸Ø©'));
            if (v === 'bag') loadBag();
            toggleSidebar(false);
        };

        function loadBag() {
            const container = document.getElementById('bagItems');
            container.innerHTML = '';

            (uData.purchasedFrames || []).forEach(itemRef => {
                const item = storeData.frames.find(x => x.id === itemRef.id);
                if (!item) return;
                const isEquipped = uData.activeFrame === item.id;
                container.innerHTML += `
                    <div class="store-card">
                        <span class="item-label">Ø¥Ø·Ø§Ø±</span>
                        <img src="${item.image}" class="w-16 mt-6">
                        <div class="text-[10px] font-bold mt-1">${item.name}</div>
                        <button onclick="${isEquipped ? `equip('null')` : `equip('${item.id}')`}"
                                class="action-btn ${isEquipped ? 'btn-unequip' : 'btn-equip'}">
                            ${isEquipped ? 'Ø®Ù„Ø¹' : 'Ø§Ø±ØªØ¯Ø§Ø¡'}
                        </button>
                    </div>
                `;
            });
        }

        window.equip = async (id) => {
            await updateDoc(doc(db, "users", auth.currentUser.uid), { activeFrame: id === 'null' ? null : id });
            loadBag();
        };

        window.recharge = async (amt, price) => {
            await updateDoc(doc(db, "users", auth.currentUser.uid), { balance: increment(amt) });
            showToast("ØªÙ… Ø´Ø­Ù† Ø§Ù„Ø±ØµÙŠØ¯ Ø¨Ù†Ø¬Ø§Ø­");
        };

        window.toggleSidebar = (show) => {
            const side = document.getElementById('sidebar');
            const over = document.getElementById('overlay');
            if (show === false) { side.classList.remove('open'); over.classList.remove('active'); return; }
            side.classList.toggle('open');
            over.classList.toggle('active');
        };

        async function loadBanners() {
            const snap = await getDocs(collection(db, "banners"));
            const container = document.getElementById('bannerContainer');
            if (snap.empty) {
                container.innerHTML = `<img src="https://images.unsplash.com/photo-1614850523060-8da1d56ae167?q=80&w=2070&auto=format&fit=crop" class="w-full h-full object-cover">`;
                return;
            }
            container.innerHTML = `<img src="${snap.docs[0].data().imageUrl}" class="w-full h-full object-cover">`;
        }

        window.loginWithGoogle = async () => {
            const res = await signInWithPopup(auth, new GoogleAuthProvider());
            const userRef = doc(db, "users", res.user.uid);
            const snap = await getDoc(userRef);
            if (!snap.exists()) {
                await setDoc(userRef, {
                    displayName: res.user.displayName,
                    photoURL: res.user.photoURL,
                    balance: 1000,
                    wealthLevel: 1,
                    customId: Math.floor(10000000 + Math.random() * 90000000).toString()
                });
            }
        };

        function showToast(m, t='success') {
            const c = document.getElementById('toastContainer');
            const d = document.createElement('div');
            d.className = `${t==='success'?'bg-green-500':'bg-red-500'} text-white px-6 py-2 rounded-full mb-2 text-xs font-bold shadow-lg`;
            d.innerText = m;
            c.appendChild(d);
            setTimeout(() => d.remove(), 3000);
        }

        window.copyID = () => { navigator.clipboard.writeText(uData.customId); showToast("ØªÙ… Ø§Ù„Ù†Ø³Ø®"); };
        window.logout = () => signOut(auth);
    </script>
</body>
</html>
